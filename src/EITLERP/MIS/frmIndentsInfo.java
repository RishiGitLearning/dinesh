/*
 * frmIndentsInfo.java
 *
 * Created on July 13, 2005, 10:47 AM
 */

package EITLERP.MIS;

import EITLERP.*;
import EITLERP.Stores.*;
import EITLERP.Purchase.*;
import javax.swing.*;
import java.awt.*;
import java.util.*;
import java.sql.*;
import java.net.*;

/**
 *
 * @author  root
 */
public class frmIndentsInfo extends javax.swing.JApplet {
    
    private EITLTableModel DataModelI=new EITLTableModel();
    private EITLTableModel DataModelU=new EITLTableModel();
    private EITLComboModel cmbBuyerModel=new EITLComboModel();
    private EITLComboModel cmbOrderModel=new EITLComboModel();
    
    private EITLComboModel cmbDeptModel=new EITLComboModel();
    private EITLComboModel cmbApprovalModel=new EITLComboModel();
    
    
    /** Initializes the applet frmIndentsInfo */
    public void init() {
        setSize(573, 408);
        initComponents();
        GenerateCombo();
        FormatGridI();
        FormatGridU();
        EITLERPGLOBAL.setComboIndex(cmbBuyer,EITLERPGLOBAL.gUserID);
        txtRIA.setVisible(false);
    }
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        cmbBuyer = new javax.swing.JComboBox();
        jTabbedPane1 = new javax.swing.JTabbedPane();
        jPanel2 = new javax.swing.JPanel();
        cmdShowI = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        TableI = new javax.swing.JTable();
        cmdOpenI = new javax.swing.JButton();
        cmdPreview = new javax.swing.JButton();
        jLabel3 = new javax.swing.JLabel();
        cmbOrder = new javax.swing.JComboBox();
        txtRIA = new javax.swing.JTextField();
        jPanel3 = new javax.swing.JPanel();
        cmdShowU = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        TableU = new javax.swing.JTable();
        cmdOpenU = new javax.swing.JButton();
        cmdPreviewU = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jLabel4 = new javax.swing.JLabel();
        txtFromDate = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        txtToDate = new javax.swing.JTextField();
        chkDept = new javax.swing.JCheckBox();
        cmbApproval = new javax.swing.JComboBox();
        chkApproval = new javax.swing.JCheckBox();
        cmbDept = new javax.swing.JComboBox();
        cmdPreview3 = new javax.swing.JButton();

        getContentPane().setLayout(null);

        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                formMouseClicked(evt);
            }
        });

        jPanel1.setLayout(null);

        jPanel1.setBackground(new java.awt.Color(0, 102, 255));
        jPanel1.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jLabel1.setForeground(new java.awt.Color(255, 255, 255));
        jLabel1.setText("BUYERWISE INDENTS PENDING FOR PO CREATION");
        jPanel1.add(jLabel1);
        jLabel1.setBounds(8, 7, 312, 15);

        getContentPane().add(jPanel1);
        jPanel1.setBounds(2, 2, 570, 29);

        jLabel2.setText("Buyer");
        getContentPane().add(jLabel2);
        jLabel2.setBounds(19, 53, 40, 15);

        getContentPane().add(cmbBuyer);
        cmbBuyer.setBounds(63, 48, 298, 24);

        jPanel2.setLayout(null);

        jPanel2.setBorder(new javax.swing.border.EtchedBorder());
        cmdShowI.setText("Show List");
        cmdShowI.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdShowIActionPerformed(evt);
            }
        });

        jPanel2.add(cmdShowI);
        cmdShowI.setBounds(6, 7, 118, 25);

        TableI.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        TableI.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                TableIMouseClicked(evt);
            }
        });

        jScrollPane1.setViewportView(TableI);

        jPanel2.add(jScrollPane1);
        jScrollPane1.setBounds(9, 48, 527, 183);

        cmdOpenI.setText("Open Document");
        cmdOpenI.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdOpenIActionPerformed(evt);
            }
        });

        jPanel2.add(cmdOpenI);
        cmdOpenI.setBounds(373, 241, 162, 25);

        cmdPreview.setText("Preview Report");
        cmdPreview.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdPreviewActionPerformed(evt);
            }
        });

        jPanel2.add(cmdPreview);
        cmdPreview.setBounds(198, 242, 162, 25);

        jLabel3.setText("Order by");
        jPanel2.add(jLabel3);
        jLabel3.setBounds(302, 20, 65, 18);

        jPanel2.add(cmbOrder);
        cmbOrder.setBounds(369, 17, 163, 22);

        jPanel2.add(txtRIA);
        txtRIA.setBounds(20, 240, 4, 19);

        jTabbedPane1.addTab("Indents pending for PO creation", jPanel2);

        jPanel3.setLayout(null);

        jPanel3.setBorder(new javax.swing.border.EtchedBorder());
        cmdShowU.setText("Show List");
        cmdShowU.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdShowUActionPerformed(evt);
            }
        });

        jPanel3.add(cmdShowU);
        cmdShowU.setBounds(6, 7, 118, 25);

        TableU.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jScrollPane2.setViewportView(TableU);

        jPanel3.add(jScrollPane2);
        jScrollPane2.setBounds(7, 43, 534, 194);

        cmdOpenU.setText("Open Document");
        cmdOpenU.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdOpenUActionPerformed(evt);
            }
        });

        jPanel3.add(cmdOpenU);
        cmdOpenU.setBounds(373, 241, 162, 25);

        cmdPreviewU.setText("Preview Report");
        cmdPreviewU.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdPreviewUActionPerformed(evt);
            }
        });

        jPanel3.add(cmdPreviewU);
        cmdPreviewU.setBounds(198, 242, 162, 25);

        jTabbedPane1.addTab("Indents Under Approval", jPanel3);

        jPanel4.setLayout(null);

        jPanel4.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(0, 0, 0)));
        jLabel4.setText("From Date :");
        jPanel4.add(jLabel4);
        jLabel4.setBounds(17, 27, 80, 15);

        txtFromDate.setNextFocusableComponent(txtToDate);
        jPanel4.add(txtFromDate);
        txtFromDate.setBounds(95, 26, 100, 18);

        jLabel5.setText("To Date :");
        jPanel4.add(jLabel5);
        jLabel5.setBounds(209, 28, 70, 15);

        txtToDate.setNextFocusableComponent(chkDept);
        jPanel4.add(txtToDate);
        txtToDate.setBounds(287, 27, 100, 18);

        chkDept.setText("Department");
        chkDept.setNextFocusableComponent(cmbDept);
        chkDept.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                chkDeptStateChanged(evt);
            }
        });

        jPanel4.add(chkDept);
        chkDept.setBounds(17, 68, 100, 22);

        cmbApproval.setNextFocusableComponent(cmdPreview3);
        cmbApproval.setEnabled(false);
        jPanel4.add(cmbApproval);
        cmbApproval.setBounds(118, 114, 270, 24);

        chkApproval.setText("Approval ");
        chkApproval.setNextFocusableComponent(cmbApproval);
        chkApproval.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                chkApprovalStateChanged(evt);
            }
        });

        jPanel4.add(chkApproval);
        chkApproval.setBounds(18, 115, 98, 22);

        cmbDept.setNextFocusableComponent(chkApproval);
        cmbDept.setEnabled(false);
        jPanel4.add(cmbDept);
        cmbDept.setBounds(118, 68, 270, 24);

        cmdPreview3.setText("Preview Report");
        cmdPreview3.setNextFocusableComponent(txtFromDate);
        cmdPreview3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdPreview3ActionPerformed(evt);
            }
        });

        jPanel4.add(cmdPreview3);
        cmdPreview3.setBounds(122, 204, 180, 24);

        jTabbedPane1.addTab("Dept.wise Query", jPanel4);

        getContentPane().add(jTabbedPane1);
        jTabbedPane1.setBounds(6, 89, 551, 306);

    }//GEN-END:initComponents
    
    private void cmdPreview3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdPreview3ActionPerformed
        // TODO add your handling code here:
        try {
            String strSQL="";
            ResultSet rsIndent;
            Statement stIndentInfo;
            ResultSet rsIndentInfo;
            ResultSet rsTmp;
            Connection tmpConn;
            
            
            data.Execute("DELETE FROM D_TMP_INDENT_INFO ");
            
            tmpConn=data.getConn();
            stIndentInfo=tmpConn.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);
            rsIndentInfo=stIndentInfo.executeQuery("SELECT * FROM D_TMP_INDENT_INFO");
            
            
            strSQL="SELECT DISTINCT(A.INDENT_NO),A.INDENT_DATE,A.APPROVED,A.FOR_DEPT_ID FROM D_INV_INDENT_HEADER A,D_INV_INDENT_DETAIL B WHERE A.INDENT_NO=B.INDENT_NO AND A.INDENT_DATE>='"+EITLERPGLOBAL.formatDateDB(txtFromDate.getText())+"' AND A.INDENT_DATE<='"+EITLERPGLOBAL.formatDateDB(txtToDate.getText())+"' AND A.CANCELED=0";
            
            if(chkDept.isSelected()) {
                strSQL+=" AND A.FOR_DEPT_ID="+EITLERPGLOBAL.getComboCode(cmbDept)+" ";
            }
            
            
            if(chkApproval.isSelected()) {
                strSQL+=" AND A.APPROVED="+EITLERPGLOBAL.getComboCode(cmbApproval)+" ";
            }
            
            long Counter=0;
            
            
            rsIndent=data.getResult(strSQL);
            if(rsIndent.getRow()>0) {
                while(!rsIndent.isAfterLast()) {
                    
                    String IndentNo=rsIndent.getString("INDENT_NO");
                    String IndentDate=rsIndent.getString("INDENT_DATE");
                    String ApprovedBy="";
                    int UserID=0;
                    
                    
                    Counter++;
                    
                    rsIndentInfo.moveToInsertRow();
                    rsIndentInfo.updateInt("COMPANY_ID",EITLERPGLOBAL.gCompanyID);
                    rsIndentInfo.updateString("INDENT_NO",IndentNo);
                    rsIndentInfo.updateString("INDENT_DATE",IndentDate);
                    rsIndentInfo.updateInt("APPROVED",rsIndent.getInt("APPROVED"));
                    
                    if(rsIndent.getInt("APPROVED")==0) {
                        UserID=ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID, 3, IndentNo);
                        ApprovedBy=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,UserID);
                    }
                    
                    rsIndentInfo.updateString("APPROVED_BY", ApprovedBy);
                    rsIndentInfo.updateString("DEPT_NAME",clsDepartment.getDeptName(EITLERPGLOBAL.gCompanyID,rsIndent.getInt("FOR_DEPT_ID")));
                    
                    
                    
                    ResultSet rsRIA;
                    HashMap lstRIA=new HashMap();
                    
                    String strRefDoc="";
                    String strRIA="";
                    
                    //=========== INQUIRIES =========//
                    lstRIA.clear();
                    
                    
                    rsRIA=data.getResult("SELECT DISTINCT(INQUIRY_NO) AS INQUIRY_NO FROM D_PUR_INQUIRY_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                    rsRIA.first();
                    
                    if(rsRIA.getRow()>0) {
                        while(!rsRIA.isAfterLast()) {
                            
                            String InquiryNo=rsRIA.getString("INQUIRY_NO");
                            
                            //Get Other Details
                            rsTmp=data.getResult("SELECT * FROM D_PUR_INQUIRY_HEADER WHERE INQUIRY_NO='"+InquiryNo+"'");
                            rsTmp.first();
                            
                            if(rsTmp.getRow()>0) {
                                InquiryNo+=" Date : "+EITLERPGLOBAL.formatDate(rsTmp.getString("INQUIRY_DATE"))+" ";
                                
                                if(rsTmp.getInt("APPROVED")==0) {
                                    UserID=ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID, 18, rsTmp.getString("INQUIRY_NO"));
                                    ApprovedBy=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,UserID);
                                    
                                    InquiryNo+=" Waiting For : "+ApprovedBy+" ";
                                }
                            }
                            
                            InquiryNo+="\n";
                            
                            lstRIA.put(InquiryNo,InquiryNo);
                            
                            rsRIA.next();
                        }
                    }
                    
                    Iterator iRIA=lstRIA.keySet().iterator();
                    
                    while(iRIA.hasNext()) {
                        strRIA=strRIA+(String)iRIA.next();
                    }
                    
                    if(!strRIA.trim().equals("")) {
                        strRefDoc="INQUIRIES \n"+strRIA;
                    }
                    
                    
                    
                    
                    
                    // ================ RIAs ==================//
                    strRIA="";
                    
                    lstRIA.clear();
                    
                    rsRIA=data.getResult("SELECT SR_NO FROM D_INV_INDENT_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                    rsRIA.first();
                    
                    if(rsRIA.getRow()>0) {
                        while(!rsRIA.isAfterLast()) {
                            int SrNo=rsRIA.getInt("SR_NO");
                            
                            String RIANo=clsIndent.getRIANo(EITLERPGLOBAL.gCompanyID, IndentNo, SrNo);
                            String RIADocNo=RIANo;
                            
                            //Get Other Details
                            rsTmp=data.getResult("SELECT * FROM D_PUR_RATE_APPROVAL_HEADER WHERE APPROVAL_NO='"+RIANo+"'");
                            rsTmp.first();
                            
                            if(rsTmp.getRow()>0) {
                                RIANo+=" Date : "+EITLERPGLOBAL.formatDate(rsTmp.getString("APPROVAL_DATE"))+" ";
                                
                                if(rsTmp.getInt("APPROVED")==0) {
                                    UserID=ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID, 38, RIADocNo);
                                    ApprovedBy=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,UserID);
                                    
                                    RIANo+=" Waiting For : "+ApprovedBy+" ";
                                }
                            }
                            
                            RIANo+="\n";
                            
                            
                            if(!RIANo.trim().equals("")) {
                                lstRIA.put(RIANo,RIANo);
                            }
                            
                            rsRIA.next();
                        }
                    }
                    
                    iRIA=lstRIA.keySet().iterator();
                    
                    while(iRIA.hasNext()) {
                        strRIA=strRIA+(String)iRIA.next();
                    }
                    
                    if(!strRIA.trim().equals("")) {
                        strRefDoc+="\n"+"RIA  \n"+strRIA;
                    }
                    
                    
                    
                    
                    //=========== POs =========//
                    strRIA="";
                    
                    lstRIA.clear();
                    
                    rsRIA=data.getResult("SELECT DISTINCT(PO_NO) AS PO_NO FROM D_PUR_PO_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                    rsRIA.first();
                    
                    if(rsRIA.getRow()>0) {
                        while(!rsRIA.isAfterLast()) {
                            
                            String PONo=rsRIA.getString("PO_NO");
                            String PODocNo=rsRIA.getString("PO_NO");
                            
                            if(PONo.trim().equals("A067667"))
                            {
                                int a=0;
                            }
                            
                            rsTmp=data.getResult("SELECT * FROM D_PUR_PO_HEADER WHERE PO_NO='"+PONo+"'");
                            rsTmp.first();
                            
                            if(rsTmp.getRow()>0) {
                                PONo+=" Date : "+EITLERPGLOBAL.formatDate(rsTmp.getString("PO_DATE"))+" ";
                                
                                if(rsTmp.getInt("APPROVED")==0) {
                                    
                                    if(rsTmp.getInt("PO_TYPE")==8) {
                                        UserID=ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID,46,PONo);
                                    }
                                    else {
                                        UserID=ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID,20+rsTmp.getInt("PO_TYPE"), rsTmp.getString("PO_NO"));
                                    }
                                    
                                    ApprovedBy=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,UserID);
                                    
                                    PONo+=" Waiting For : "+ApprovedBy+" ";
                                }
                            }
                            
                            
                            //Get the list of MIR
                            String MIRNo="";
                            String MIR="";
                            
                            rsTmp=data.getResult("SELECT DISTINCT(MIR_NO) AS MIR_NO FROM D_INV_MIR_DETAIL WHERE PO_NO='"+PODocNo+"'");
                            rsTmp.first();
                            
                            if(rsTmp.getRow()>0) {
                                
                                MIRNo=rsTmp.getString("MIR_NO");
                                
                                MIR+="=> MIR No. "+MIRNo+" ";
                                
                                rsTmp=data.getResult("SELECT * FROM D_INV_MIR_HEADER WHERE CANCELLED=0 AND MIR_NO='"+MIRNo+"'");
                                rsTmp.first();
                                if(rsTmp.getRow()>0) {
                                    MIR+=" Date : "+EITLERPGLOBAL.formatDate(rsTmp.getString("MIR_DATE"))+" ";
                                    if(rsTmp.getInt("APPROVED")==0) {
                                        UserID=ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID,4+rsTmp.getInt("MIR_TYPE"), MIRNo);
                                        ApprovedBy=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,UserID);
                                        MIR+=" Waiting For : "+ApprovedBy+" ";
                                    }
                                    
                                }
                            }
                            
                            
                            if(!MIR.trim().equals("")) {
                                PONo=PONo+"\n\n   MIRs\n"+MIR+"\n";
                            }
                            
                            
                            PONo+="\n";
                            
                            lstRIA.put(PONo,PONo);
                            
                            rsRIA.next();
                        }
                    }
                    
                    iRIA=lstRIA.keySet().iterator();
                    
                    
                    while(iRIA.hasNext()) {
                        strRIA=strRIA+(String)iRIA.next();
                    }
                    
                    if(!strRIA.trim().equals("")) {
                        strRefDoc+="\n"+"PO \n"+strRIA;
                    }
                    //==============================================//
                    
                    
                    
                    rsIndentInfo.updateString("REFERENCE_DOCS",strRefDoc);
                    rsIndentInfo.insertRow();
                    
                    
                    rsIndent.next();
                }
            }
            
            
            try {
                URL ReportFile=new URL("http://"+EITLERPGLOBAL.HostIP+"/EITLERP/Reports/rptPendingIndentsEx.jsp?dbURL="+EITLERPGLOBAL.DatabaseURL+"&CompanyID="+EITLERPGLOBAL.gCompanyID+"&FromDate="+txtFromDate.getText()+"&ToDate="+txtToDate.getText()+"");
                EITLERPGLOBAL.loginContext.showDocument(ReportFile,"_blank");
            }
            catch(Exception e) {
                JOptionPane.showMessageDialog(null,"File error "+e.getMessage());
            }
            
            
            
        }
        catch(Exception e) {
            e.printStackTrace();
        }
    }//GEN-LAST:event_cmdPreview3ActionPerformed
    
    private void chkApprovalStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_chkApprovalStateChanged
        // TODO add your handling code here:
        cmbApproval.setEnabled(chkApproval.isSelected());
    }//GEN-LAST:event_chkApprovalStateChanged
    
    private void chkDeptStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_chkDeptStateChanged
        // TODO add your handling code here:
        cmbDept.setEnabled(chkDept.isSelected());
    }//GEN-LAST:event_chkDeptStateChanged
    
    private void cmdPreviewUActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdPreviewUActionPerformed
        // TODO add your handling code here:
        int BuyerID=EITLERPGLOBAL.getComboCode(cmbBuyer);
        String BuyerName=(String)cmbBuyer.getSelectedItem();
        String strOrderby="";
        ResultSet rsIndent,rsTmp;
        
        int Orderby=EITLERPGLOBAL.getComboCode(cmbOrder);
        
        
        
        if(Orderby==1) {
            strOrderby=" ORDER BY INDENT_NO,INDENT_DATE ";
        }
        
        if(Orderby==2) {
            strOrderby=" ORDER BY INDENT_NO,APPROVED_DATE ";
        }
        
        if(Orderby==3) {
            strOrderby=" ORDER BY INDENT_NO ";
        }
        
        try {
            //Update the Indents for reference document //
            for(int i=0;i<=TableI.getRowCount()-1;i++) {
                String IndentNo=(String)TableI.getValueAt(i, 2);
                String RefDoc=(String)TableI.getValueAt(i, 7);
                
                rsIndent=data.getResult("SELECT * FROM D_INV_INDENT_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                rsIndent.first();
                
                if(rsIndent.getRow()>0) {
                    while(!rsIndent.isAfterLast()) {
                        int SrNo=rsIndent.getInt("SR_NO");
                        
                        RefDoc="";
                        
                        if(IndentNo.equals("022870")) {
                            int a=0;
                        }
                        
                        //====Inquiries ======//
                        rsTmp=data.getResult("SELECT DISTINCT(INQUIRY_NO) FROM D_PUR_INQUIRY_DETAIL WHERE INDENT_NO='"+IndentNo+"' AND INDENT_SRNO="+SrNo);
                        rsTmp.first();
                        
                        if(rsTmp.getRow()>0) {
                            RefDoc="Inquiries : ";
                            
                            while(!rsTmp.isAfterLast()) {
                                RefDoc+=rsTmp.getString("INQUIRY_NO")+",";
                                rsTmp.next();
                            }
                        }
                        //====================//
                        
                        //========== RIA ==============//
                        String RIA=clsRateApproval.getRIANo(EITLERPGLOBAL.gCompanyID,IndentNo,SrNo);
                        
                        if(!RIA.trim().equals("")) {
                            RefDoc+=" RIA : "+RIA;
                        }
                        //============================//
                        
                        
                        //==========POs========//
                        rsTmp=data.getResult("SELECT DISTINCT(PO_NO) FROM D_PUR_PO_DETAIL WHERE INDENT_NO='"+IndentNo+"' AND INDENT_SR_NO="+SrNo);
                        rsTmp.first();
                        
                        if(rsTmp.getRow()>0) {
                            RefDoc+=" PO : ";
                            
                            while(!rsTmp.isAfterLast()) {
                                RefDoc+=rsTmp.getString("PO_NO")+",";
                                rsTmp.next();
                            }
                        }
                        //======================//
                        
                        
                        data.Execute("UPDATE D_INV_INDENT_DETAIL SET REF_DOC='"+RefDoc+"' WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID+" AND INDENT_NO='"+IndentNo+"' AND SR_NO="+SrNo);
                        
                        rsIndent.next();
                    }
                }
                
                
                
            }
        }
        catch(Exception e) {
            
        }
        
        try {
            URL ReportFile=new URL("http://"+EITLERPGLOBAL.HostIP+"/EITLERP/Reports/rptPendingIndents2.jsp?dbURL="+EITLERPGLOBAL.DatabaseURL+"&CompanyID="+EITLERPGLOBAL.gCompanyID+"&BUYER="+BuyerID+"&BUYER_NAME="+BuyerName+"&ORDERBY="+strOrderby);
            EITLERPGLOBAL.loginContext.showDocument(ReportFile,"_blank");
        }
        catch(Exception e) {
            JOptionPane.showMessageDialog(null,"File error "+e.getMessage());
        }
        
    }//GEN-LAST:event_cmdPreviewUActionPerformed
    
    private void TableIMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_TableIMouseClicked
        // TODO add your handling code here:
        if(evt.getClickCount()>=2) {
            if(TableI.getRowCount()>0) {
                txtRIA.setText((String)TableI.getValueAt(TableI.getSelectedRow(), 7));
                BigEdit bigEdit=new BigEdit();
                bigEdit.theText=txtRIA;
                bigEdit.ShowEdit();
            }
        }
    }//GEN-LAST:event_TableIMouseClicked
    
    private void cmdPreviewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdPreviewActionPerformed
        // TODO add your handling code here:
        int BuyerID=EITLERPGLOBAL.getComboCode(cmbBuyer);
        String BuyerName=(String)cmbBuyer.getSelectedItem();
        String strOrderby="";
        ResultSet rsIndent,rsTmp;
        
        int Orderby=EITLERPGLOBAL.getComboCode(cmbOrder);
        
        
        
        if(Orderby==1) {
            strOrderby=" ORDER BY INDENT_NO,INDENT_DATE ";
        }
        
        if(Orderby==2) {
            strOrderby=" ORDER BY INDENT_NO,APPROVED_DATE ";
        }
        
        if(Orderby==3) {
            strOrderby=" ORDER BY INDENT_NO ";
        }
        
        if(Orderby==4) {
                strOrderby=" ORDER BY FOR_DEPT_ID,INDENT_DATE ";
        }
        
        try {
            //Update the Indents for reference document //
            for(int i=0;i<=TableI.getRowCount()-1;i++) {
                String IndentNo=(String)TableI.getValueAt(i, 2);
                String RefDoc=(String)TableI.getValueAt(i, 7);
                
                rsIndent=data.getResult("SELECT * FROM D_INV_INDENT_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                rsIndent.first();
                
                if(rsIndent.getRow()>0) {
                    while(!rsIndent.isAfterLast()) {
                        int SrNo=rsIndent.getInt("SR_NO");
                        
                        RefDoc="";
                        
                        if(IndentNo.equals("022870")) {
                            int a=0;
                        }
                        
                        //====Inquiries ======//
                        rsTmp=data.getResult("SELECT DISTINCT(INQUIRY_NO) FROM D_PUR_INQUIRY_DETAIL WHERE INDENT_NO='"+IndentNo+"' AND INDENT_SRNO="+SrNo);
                        rsTmp.first();
                        
                        if(rsTmp.getRow()>0) {
                            RefDoc="Inquiries : ";
                            
                            while(!rsTmp.isAfterLast()) {
                                RefDoc+=rsTmp.getString("INQUIRY_NO")+",";
                                rsTmp.next();
                            }
                        }
                        //====================//
                        
                        //========== RIA ==============//
                        String RIA=clsRateApproval.getRIANo(EITLERPGLOBAL.gCompanyID,IndentNo,SrNo);
                        
                        if(!RIA.trim().equals("")) {
                            RefDoc+=" RIA : "+RIA;
                        }
                        //============================//
                        
                        
                        //==========POs========//
                        rsTmp=data.getResult("SELECT DISTINCT(PO_NO) FROM D_PUR_PO_DETAIL WHERE INDENT_NO='"+IndentNo+"' AND INDENT_SR_NO="+SrNo);
                        rsTmp.first();
                        
                        if(rsTmp.getRow()>0) {
                            RefDoc+=" PO : ";
                            
                            while(!rsTmp.isAfterLast()) {
                                RefDoc+=rsTmp.getString("PO_NO")+",";
                                rsTmp.next();
                            }
                        }
                        //======================//
                        
                        
                        data.Execute("UPDATE D_INV_INDENT_DETAIL SET REF_DOC='"+RefDoc+"' WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID+" AND INDENT_NO='"+IndentNo+"' AND SR_NO="+SrNo);
                        
                        rsIndent.next();
                    }
                }
                
                
                
            }
        }
        catch(Exception e) {
            
        }
        
        
        try {
            URL ReportFile=new URL("http://"+EITLERPGLOBAL.HostIP+"/EITLERP/Reports/rptPendingIndents.jsp?dbURL="+EITLERPGLOBAL.DatabaseURL+"&CompanyID="+EITLERPGLOBAL.gCompanyID+"&BUYER="+BuyerID+"&BUYER_NAME="+BuyerName+"&ORDERBY="+strOrderby);
            EITLERPGLOBAL.loginContext.showDocument(ReportFile,"_blank");
        }
        catch(Exception e) {
            JOptionPane.showMessageDialog(null,"File error "+e.getMessage());
        }
        
    }//GEN-LAST:event_cmdPreviewActionPerformed
    
    private void formMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_formMouseClicked
        // TODO add your handling code here:
    }//GEN-LAST:event_formMouseClicked
    
    private void cmdOpenUActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdOpenUActionPerformed
        // TODO add your handling code here:
        try {
            
            String DocNo=(String)TableU.getValueAt(TableU.getSelectedRow(), 2);
            AppletFrame aFrame=new AppletFrame("Indent");
            aFrame.startAppletEx("EITLERP.Stores.FrmIndent","Indent");
            FrmIndent ObjDoc=(FrmIndent) aFrame.ObjApplet;
            ObjDoc.FindEx((int)EITLERPGLOBAL.gCompanyID,DocNo);
        }
        catch(Exception e) {
            
        }
    }//GEN-LAST:event_cmdOpenUActionPerformed
    
    private void cmdShowUActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdShowUActionPerformed
        // TODO add your handling code here:
        GenerateUnapprovedIndents();
    }//GEN-LAST:event_cmdShowUActionPerformed
    
    private void cmdOpenIActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdOpenIActionPerformed
        // TODO add your handling code here:
        try {
            
            String DocNo=(String)TableI.getValueAt(TableI.getSelectedRow(), 2);
            AppletFrame aFrame=new AppletFrame("Indent");
            aFrame.startAppletEx("EITLERP.Stores.FrmIndent","Indent");
            FrmIndent ObjDoc=(FrmIndent) aFrame.ObjApplet;
            ObjDoc.FindEx((int)EITLERPGLOBAL.gCompanyID,DocNo);
        }
        catch(Exception e) {
            
        }
    }//GEN-LAST:event_cmdOpenIActionPerformed
    
    private void cmdShowIActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdShowIActionPerformed
        // TODO add your handling code here:
        GeneratePendingIndents();
    }//GEN-LAST:event_cmdShowIActionPerformed
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable TableI;
    private javax.swing.JTable TableU;
    private javax.swing.JCheckBox chkApproval;
    private javax.swing.JCheckBox chkDept;
    private javax.swing.JComboBox cmbApproval;
    private javax.swing.JComboBox cmbBuyer;
    private javax.swing.JComboBox cmbDept;
    private javax.swing.JComboBox cmbOrder;
    private javax.swing.JButton cmdOpenI;
    private javax.swing.JButton cmdOpenU;
    private javax.swing.JButton cmdPreview;
    private javax.swing.JButton cmdPreview3;
    private javax.swing.JButton cmdPreviewU;
    private javax.swing.JButton cmdShowI;
    private javax.swing.JButton cmdShowU;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTabbedPane jTabbedPane1;
    private javax.swing.JTextField txtFromDate;
    private javax.swing.JTextField txtRIA;
    private javax.swing.JTextField txtToDate;
    // End of variables declaration//GEN-END:variables
    
    
    private void GenerateCombo() {
        cmbBuyerModel=new EITLComboModel();
        cmbBuyer.removeAllItems();
        cmbBuyer.setModel(cmbBuyerModel);
        
        HashMap List=new HashMap();
        List=(new clsUser()).getList(" WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID);
        
        for(int i=1;i<=List.size();i++) {
            clsUser ObjUser=(clsUser)List.get(Integer.toString(i));
            
            ComboData aData=new ComboData();
            aData.Code=(int)ObjUser.getAttribute("USER_ID").getVal();
            aData.Text=(String)ObjUser.getAttribute("USER_NAME").getObj();
            
            cmbBuyerModel.addElement(aData);
        }
        
        cmbOrderModel=new EITLComboModel();
        cmbOrder.removeAllItems();
        cmbOrder.setModel(cmbOrderModel);
        
        ComboData aData=new ComboData();
        aData.Code=1;
        aData.Text="Document Date";
        cmbOrderModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=2;
        aData.Text="Approved Date";
        cmbOrderModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=3;
        aData.Text="Document No.";
        cmbOrderModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=4;
        aData.Text="Department";
        cmbOrderModel.addElement(aData);
        
        cmbApprovalModel=new EITLComboModel();
        cmbApproval.removeAllItems();
        cmbApproval.setModel(cmbApprovalModel);
        
        aData=new ComboData();
        aData.Code=1;
        aData.Text="Approved Indents";
        cmbApprovalModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=0;
        aData.Text="UnApproved Indents";
        cmbApprovalModel.addElement(aData);
        
        
        cmbDeptModel=new EITLComboModel();
        cmbDept.removeAllItems();
        cmbDept.setModel(cmbDeptModel);
        
        List=clsDepartment.getList(" WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID);
        for(int i=1;i<=List.size();i++) {
            clsDepartment ObjDept=(clsDepartment) List.get(Integer.toString(i));
            aData=new ComboData();
            aData.Code=(int) ObjDept.getAttribute("DEPT_ID").getVal();
            aData.Text=(String) ObjDept.getAttribute("DEPT_DESC").getObj();
            cmbDeptModel.addElement(aData);
        }
        
    }
    
    
    private void FormatGridI() {
        DataModelI=new EITLTableModel();
        TableI.removeAll();
        TableI.setModel(DataModelI);
        
        TableI.setAutoResizeMode(TableI.AUTO_RESIZE_OFF);
        
        DataModelI.addColumn("Sr.");
        DataModelI.addColumn("Buyer");
        DataModelI.addColumn("Indent No.");
        DataModelI.addColumn("Date");
        DataModelI.addColumn("Department");
        DataModelI.addColumn("Approved On");
        DataModelI.addColumn("Approved By");
        DataModelI.addColumn("RIA No.");
        
        DataModelI.TableReadOnly(true);
        
    }
    
    
    private void FormatGridU() {
        DataModelU=new EITLTableModel();
        TableU.removeAll();
        TableU.setModel(DataModelU);
        
        TableU.setAutoResizeMode(TableI.AUTO_RESIZE_OFF);
        
        DataModelU.addColumn("Sr.");
        DataModelU.addColumn("Buyer");
        DataModelU.addColumn("Indent No.");
        DataModelU.addColumn("Date");
        DataModelU.addColumn("Department");
        DataModelU.addColumn("User");
        DataModelU.addColumn("Received Date");
        DataModelU.TableReadOnly(true);
        
    }
    
    private void GeneratePendingIndents() {
        
        int DeptID=0;
        int SelUserID=0;
        String strSQL="";
        String strRIA="";
        
        try {
            
            FormatGridI(); //clear existing content of table
            SelUserID=EITLERPGLOBAL.getComboCode(cmbBuyer);
            
            //Check if this user is HOD of the department
            ResultSet rsTmp,rsBuyer,rsIndent,rsRIA;
            //rsTmp=data.getResult("SELECT CREATED_BY,INDENT_NO,INDENT_DATE,FOR_DEPT_ID FROM D_INV_INDENT_HEADER WHERE APPROVED=1 AND CANCELED=0 AND INDENT_NO IN (SELECT INDENT_NO FROM D_INV_INDENT_DETAIL WHERE PO_QTY<QTY) AND FOR_DEPT_ID IN (SELECT DEPT_ID FROM D_COM_DEPT_BUYERS WHERE BUYER="+SelUserID+")");
            
            //New Logic with Item Code
            strSQL="";
            
            //Old Original Query
            strSQL=strSQL+" SELECT A.INDENT_NO,A.INDENT_DATE AS INDENT_DATE,A.FOR_DEPT_ID,A.CREATED_BY,A.APPROVED_DATE AS APPROVED_DATE FROM ";
            strSQL=strSQL+" D_INV_INDENT_HEADER A, ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL B ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=B.INDENT_NO AND ";
            strSQL=strSQL+" A.APPROVED=1 AND ";
            strSQL=strSQL+" A.CANCELED=0 AND ";
            strSQL=strSQL+" A.FOR_DEPT_ID IN (SELECT DEPT_ID FROM D_COM_DEPT_BUYERS WHERE BUYER="+SelUserID+")  AND ";
            strSQL=strSQL+" B.PO_QTY<B.QTY AND ";
            
            strSQL=strSQL+" A.INDENT_NO NOT IN ( ";
            strSQL=strSQL+" SELECT DISTINCT(C.INDENT_NO)  AS INDENT_NO FROM ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=1 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER<>"+SelUserID+" AND ";
            strSQL=strSQL+" B.ITEM_ID=SUBSTRING(A.ITEM_CODE,1,LENGTH(B.ITEM_ID)) ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(A.INDENT_NO) AS INDENT_NO FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C, ";
            strSQL=strSQL+" D_INV_ITEM_MASTER D ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=1 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER<>"+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_CLASS<>'' AND ";
            strSQL=strSQL+" A.ITEM_CODE=D.ITEM_ID AND D.CANCELLED=0 AND ";
            strSQL=strSQL+" D.ABC=B.ITEM_CLASS ) ";
            
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(C.INDENT_NO)  AS INDENT_NO,C.INDENT_DATE AS INDENT_DATE,C.FOR_DEPT_ID,C.CREATED_BY,C.APPROVED_DATE AS APPROVED_DATE FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=1 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER="+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_ID=SUBSTRING(A.ITEM_CODE,1,LENGTH(B.ITEM_ID)) ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(A.INDENT_NO) AS INDENT_NO,C.INDENT_DATE AS INDENT_DATE,C.FOR_DEPT_ID,C.CREATED_BY,C.APPROVED_DATE AS APPROVED_DATE FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C, ";
            strSQL=strSQL+" D_INV_ITEM_MASTER D ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=1 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER="+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_CLASS<>'' AND ";
            strSQL=strSQL+" A.ITEM_CODE=D.ITEM_ID AND D.CANCELLED=0 AND ";
            strSQL=strSQL+" D.ABC=B.ITEM_CLASS  ";

            
            /*strSQL=strSQL+" SELECT A.INDENT_NO,A.INDENT_DATE AS INDENT_DATE,A.FOR_DEPT_ID,A.CREATED_BY,A.APPROVED_DATE AS APPROVED_DATE FROM ";
            strSQL=strSQL+" D_INV_INDENT_HEADER A, ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL B ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=B.INDENT_NO AND ";
            strSQL=strSQL+" A.APPROVED=1 AND ";
            strSQL=strSQL+" A.CANCELED=0 AND ";
            strSQL=strSQL+" A.FOR_DEPT_ID IN (SELECT DEPT_ID FROM D_COM_DEPT_BUYERS WHERE BUYER="+SelUserID+")  AND ";
            strSQL=strSQL+" B.PO_QTY<B.QTY ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(C.INDENT_NO)  AS INDENT_NO,C.INDENT_DATE AS INDENT_DATE,C.FOR_DEPT_ID,C.CREATED_BY,C.APPROVED_DATE AS APPROVED_DATE FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=1 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER="+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_ID=SUBSTRING(A.ITEM_CODE,1,LENGTH(B.ITEM_ID)) ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(A.INDENT_NO) AS INDENT_NO,C.INDENT_DATE AS INDENT_DATE,C.FOR_DEPT_ID,C.CREATED_BY,C.APPROVED_DATE AS APPROVED_DATE FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C, ";
            strSQL=strSQL+" D_INV_ITEM_MASTER D ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=1 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER="+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_CLASS<>'' AND ";
            strSQL=strSQL+" A.ITEM_CODE=D.ITEM_ID AND ";
            strSQL=strSQL+" D.ABC=B.ITEM_CLASS  ";*/
            
            int Orderby=EITLERPGLOBAL.getComboCode(cmbOrder);
            
            if(Orderby==1) {
                strSQL=strSQL+" ORDER BY INDENT_DATE ";
            }
            
            if(Orderby==2) {
                strSQL=strSQL+" ORDER BY APPROVED_DATE ";
            }
            
            if(Orderby==3) {
                strSQL=strSQL+" ORDER BY INDENT_NO ";
            }
            
            if(Orderby==4) {
                strSQL=strSQL+" ORDER BY FOR_DEPT_ID,INDENT_DATE ";
            }
            
            System.out.println(strSQL);
            rsTmp=data.getResult(strSQL);
            rsTmp.first();
            
            if(rsTmp.getRow()>0) {
                int cnt=0;
                while(!rsTmp.isAfterLast()) {
                    cnt++;
                    
                    String BuyerName="";
                    /*rsBuyer=data.getResult("SELECT BUYER FROM D_COM_DEPT_BUYERS WHERE DEPT_ID="+rsTmp.getInt("FOR_DEPT_ID")+" AND BUYER<>"+EITLERPGLOBAL.gUserID);
                    rsBuyer.first();
                     
                    BuyerName=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,EITLERPGLOBAL.gUserID);
                     
                    if(rsBuyer.getRow()>0) {
                        BuyerName=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,rsBuyer.getInt("BUYER"));
                    }*/
                    
                    BuyerName=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,SelUserID);
                    
                    Object[] rowData=new Object[8];
                    rowData[0]=Integer.toString(cnt);
                    rowData[1]=BuyerName;
                    rowData[2]=rsTmp.getString("INDENT_NO");
                    rowData[3]=EITLERPGLOBAL.formatDate(rsTmp.getString("INDENT_DATE"));
                    rowData[4]=clsDepartment.getDeptName(EITLERPGLOBAL.gCompanyID,rsTmp.getInt("FOR_DEPT_ID"));
                    
                    
                    rsIndent=data.getResult("SELECT APPROVED_DATE,MODIFIED_BY FROM D_INV_INDENT_HEADER WHERE INDENT_NO='"+rsTmp.getString("INDENT_NO")+"'");
                    rsIndent.first();
                    
                    if(rsIndent.getRow()>0) {
                        rowData[5]=EITLERPGLOBAL.formatDate(rsIndent.getString("APPROVED_DATE"));
                        rowData[6]=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,rsIndent.getInt("MODIFIED_BY"));
                    }
                    else {
                        rowData[5]="";
                        rowData[6]="";
                    }
                    
                    
                    HashMap lstRIA=new HashMap();
                    
                    String strRefDoc="";
                    
                    strRIA="";
                    
                    
                    //=========== INQUIRIES =========//
                    lstRIA.clear();
                    
                    String IndentNo=rsTmp.getString("INDENT_NO");
                    rsRIA=data.getResult("SELECT DISTINCT(INQUIRY_NO) AS INQUIRY_NO FROM D_PUR_INQUIRY_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                    rsRIA.first();
                    
                    if(rsRIA.getRow()>0) {
                        while(!rsRIA.isAfterLast()) {
                            
                            String InquiryNo=rsRIA.getString("INQUIRY_NO");
                            
                            lstRIA.put(InquiryNo,InquiryNo);
                            
                            rsRIA.next();
                        }
                    }
                    
                    Iterator iRIA=lstRIA.keySet().iterator();
                    
                    
                    while(iRIA.hasNext()) {
                        strRIA=strRIA+(String)iRIA.next()+",";
                    }
                    
                    if(!strRIA.trim().equals("")) {
                        strRefDoc="Inquiries : "+strRIA;
                    }
                    
                    
                    
                    // ================ RIAs ==================//
                    strRIA="";
                    
                    lstRIA.clear();
                    
                    rsRIA=data.getResult("SELECT SR_NO FROM D_INV_INDENT_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                    rsRIA.first();
                    
                    if(rsRIA.getRow()>0) {
                        while(!rsRIA.isAfterLast()) {
                            int SrNo=rsRIA.getInt("SR_NO");
                            
                            String RIANo=clsIndent.getRIANo(EITLERPGLOBAL.gCompanyID, IndentNo, SrNo);
                            
                            if(!RIANo.trim().equals("")) {
                                lstRIA.put(RIANo,RIANo);
                            }
                            
                            rsRIA.next();
                        }
                    }
                    
                    
                    
                    iRIA=lstRIA.keySet().iterator();
                    
                    while(iRIA.hasNext()) {
                        strRIA=strRIA+(String)iRIA.next()+",";
                    }
                    
                    if(!strRIA.trim().equals("")) {
                        strRefDoc+="\n"+"RIAs : "+strRIA;
                    }
                    
                    
                    
                    //=========== POs =========//
                    strRIA="";
                    
                    lstRIA.clear();
                    
                    rsRIA=data.getResult("SELECT DISTINCT(PO_NO) AS PO_NO FROM D_PUR_PO_DETAIL WHERE INDENT_NO='"+IndentNo+"'");
                    rsRIA.first();
                    
                    if(rsRIA.getRow()>0) {
                        while(!rsRIA.isAfterLast()) {
                            
                            String PONo=rsRIA.getString("PO_NO");
                            
                            lstRIA.put(PONo,PONo);
                            
                            rsRIA.next();
                        }
                    }
                    
                    iRIA=lstRIA.keySet().iterator();
                    
                    
                    while(iRIA.hasNext()) {
                        strRIA=strRIA+(String)iRIA.next()+",";
                    }
                    
                    if(!strRIA.trim().equals("")) {
                        strRefDoc+="\n"+"POs : "+strRIA;
                    }
                    //==============================================//
                    
                    
                    
                    
                    rowData[7]=strRefDoc;
                    
                    DataModelI.addRow(rowData);
                    
                    rsTmp.next();
                }
            }
            
            
        }
        catch(Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(null,e.getMessage());
        }
    }
    
    private void GenerateUnapprovedIndents() {
        
        int DeptID=0;
        int SelUserID=0;
        String strSQL="";
        
        try {
            
            FormatGridU(); //clear existing content of table
            SelUserID=EITLERPGLOBAL.getComboCode(cmbBuyer);
            
            //Check if this user is HOD of the department
            ResultSet rsTmp,rsBuyer;
            //rsTmp=data.getResult("SELECT INDENT_NO,INDENT_DATE,FOR_DEPT_ID FROM D_INV_INDENT_HEADER WHERE APPROVED=0 AND CANCELED=0 AND FOR_DEPT_ID IN (SELECT DEPT_ID FROM D_COM_DEPT_BUYERS WHERE BUYER="+SelUserID+")");
            //rsTmp.first();
            
            strSQL="";
            
            strSQL=strSQL+" SELECT A.INDENT_NO,A.INDENT_DATE AS INDENT_DATE,A.FOR_DEPT_ID,A.CREATED_BY FROM ";
            strSQL=strSQL+" D_INV_INDENT_HEADER A, ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL B ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=B.INDENT_NO AND ";
            strSQL=strSQL+" A.APPROVED=0 AND ";
            strSQL=strSQL+" A.CANCELED=0 AND ";
            strSQL=strSQL+" A.FOR_DEPT_ID IN (SELECT DEPT_ID FROM D_COM_DEPT_BUYERS WHERE BUYER="+SelUserID+")  AND ";
            strSQL=strSQL+" A.INDENT_NO NOT IN ( ";
            strSQL=strSQL+" SELECT DISTINCT(C.INDENT_NO)  AS INDENT_NO FROM ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=0 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" A.PO_QTY<QTY AND ";
            strSQL=strSQL+" B.BUYER<>"+SelUserID+" AND ";
            strSQL=strSQL+" B.ITEM_ID=SUBSTRING(A.ITEM_CODE,1,LENGTH(B.ITEM_ID)) ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(A.INDENT_NO) AS INDENT_NO FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C, ";
            strSQL=strSQL+" D_INV_ITEM_MASTER D ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=0 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" B.BUYER<>"+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_CLASS<>'' AND ";
            strSQL=strSQL+" A.ITEM_CODE=D.ITEM_ID AND D.CANCELLED=0 AND ";
            strSQL=strSQL+" D.ABC=B.ITEM_CLASS ) ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(C.INDENT_NO)  AS INDENT_NO,C.INDENT_DATE AS INDENT_DATE,C.FOR_DEPT_ID,C.CREATED_BY FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=0 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" B.BUYER="+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_ID=SUBSTRING(A.ITEM_CODE,1,LENGTH(B.ITEM_ID)) ";
            strSQL=strSQL+" UNION ";
            strSQL=strSQL+" SELECT DISTINCT(A.INDENT_NO) AS INDENT_NO,C.INDENT_DATE AS INDENT_DATE,C.FOR_DEPT_ID,C.CREATED_BY FROM  ";
            strSQL=strSQL+" D_INV_INDENT_DETAIL A, ";
            strSQL=strSQL+" D_COM_BUYER_ITEMS B, ";
            strSQL=strSQL+" D_INV_INDENT_HEADER C, ";
            strSQL=strSQL+" D_INV_ITEM_MASTER D ";
            strSQL=strSQL+" WHERE ";
            strSQL=strSQL+" A.INDENT_NO=C.INDENT_NO AND ";
            strSQL=strSQL+" C.APPROVED=0 AND C.CANCELED=0 AND ";
            strSQL=strSQL+" B.BUYER="+SelUserID+" AND  ";
            strSQL=strSQL+" B.ITEM_CLASS<>'' AND ";
            strSQL=strSQL+" A.ITEM_CODE=D.ITEM_ID AND D.CANCELLED=0 AND ";
            strSQL=strSQL+" D.ABC=B.ITEM_CLASS  ";
            strSQL=strSQL+" ORDER BY INDENT_DATE ";
            
            rsTmp=data.getResult(strSQL);
            rsTmp.first();
            
            
            if(rsTmp.getRow()>0) {
                int cnt=0;
                while(!rsTmp.isAfterLast()) {
                    cnt++;
                    
                    String BuyerName="";
                    
                    /*rsBuyer=data.getResult("SELECT BUYER FROM D_COM_DEPT_BUYERS WHERE DEPT_ID="+rsTmp.getInt("FOR_DEPT_ID")+" AND BUYER<>"+EITLERPGLOBAL.gUserID);
                    rsBuyer.first();
                    BuyerName=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,EITLERPGLOBAL.gUserID);
                     
                    if(rsBuyer.getRow()>0) {
                        BuyerName=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,rsBuyer.getInt("BUYER"));
                    }*/
                    
                    BuyerName=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,SelUserID);
                    
                    Object[] rowData=new Object[7];
                    rowData[0]=Integer.toString(cnt);
                    rowData[1]=BuyerName;
                    rowData[2]=rsTmp.getString("INDENT_NO");
                    rowData[3]=EITLERPGLOBAL.formatDate(rsTmp.getString("INDENT_DATE"));
                    rowData[4]=clsDepartment.getDeptName(EITLERPGLOBAL.gCompanyID,rsTmp.getInt("FOR_DEPT_ID"));
                    rowData[5]=clsUser.getUserName(EITLERPGLOBAL.gCompanyID,ApprovalFlow.getWaitingUser(EITLERPGLOBAL.gCompanyID, 3, rsTmp.getString("INDENT_NO")));
                    rowData[6]=EITLERPGLOBAL.formatDate(ApprovalFlow.getWaitingReceivedDate(EITLERPGLOBAL.gCompanyID, 3, rsTmp.getString("INDENT_NO")));
                    
                    
                    DataModelU.addRow(rowData);
                    
                    rsTmp.next();
                }
            }
            
            
        }
        catch(Exception e) {
            
        }
    }
    
}
