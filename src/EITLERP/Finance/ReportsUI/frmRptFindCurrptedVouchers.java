/*
 * frmVoucherPrinting.java
 *
 * Created on January 20, 2008, 4:00 PM
 */

package EITLERP.Finance.ReportsUI;

/**
 *
 * @author  root
 */
import javax.swing.*;
import java.awt.*;
import java.util.*;
import TReportWriter.*;
import TReportWriter.SimpleDataProvider.*;
import java.net.*;
import java.sql.*;
import EITLERP.*;
import EITLERP.Finance.*;
import EITLERP.Finance.Config.*;
import EITLERP.Finance.ReportsUI.*;


public class frmRptFindCurrptedVouchers extends javax.swing.JApplet {
    
    private EITLComboModel cmbVoucherTypeModel;
    private TReportEngine objEngine=new TReportEngine();
    private TReportWriter.SimpleDataProvider.TTable objData=new TReportWriter.SimpleDataProvider.TTable();
    /** Initializes the applet frmVoucherPrinting */
    public void init() {
        setSize(424,225);
        initComponents();
        GenerateCombo();
        lblBar.setVisible(false);
        Bar.setVisible(false);
    }
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        lblTitle = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        txtFromDate = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        txtToDate = new javax.swing.JTextField();
        cmdPrint = new javax.swing.JButton();
        cmdExit = new javax.swing.JButton();
        cmbVoucherType = new javax.swing.JComboBox();
        jLabel6 = new javax.swing.JLabel();
        lblBar = new javax.swing.JLabel();
        Bar = new javax.swing.JProgressBar();

        getContentPane().setLayout(null);

        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                formMouseClicked(evt);
            }
        });

        lblTitle.setBackground(new java.awt.Color(0, 102, 153));
        lblTitle.setForeground(java.awt.Color.white);
        lblTitle.setText(" FIND  VOUCHER ");
        lblTitle.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        lblTitle.setOpaque(true);
        getContentPane().add(lblTitle);
        lblTitle.setBounds(-2, 1, 666, 25);

        jLabel4.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jLabel4.setText("Date From :");
        getContentPane().add(jLabel4);
        jLabel4.setBounds(5, 40, 105, 15);

        getContentPane().add(txtFromDate);
        txtFromDate.setBounds(115, 40, 110, 19);

        jLabel5.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jLabel5.setText("To :");
        getContentPane().add(jLabel5);
        jLabel5.setBounds(240, 42, 25, 15);

        getContentPane().add(txtToDate);
        txtToDate.setBounds(270, 40, 110, 19);

        cmdPrint.setText("Print");
        cmdPrint.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdPrintActionPerformed(evt);
            }
        });

        getContentPane().add(cmdPrint);
        cmdPrint.setBounds(90, 150, 80, 25);

        cmdExit.setText("Exit");
        cmdExit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdExitActionPerformed(evt);
            }
        });

        getContentPane().add(cmdExit);
        cmdExit.setBounds(210, 150, 80, 25);

        getContentPane().add(cmbVoucherType);
        cmbVoucherType.setBounds(115, 70, 265, 24);

        jLabel6.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jLabel6.setText("Voucher Type :");
        getContentPane().add(jLabel6);
        jLabel6.setBounds(5, 73, 105, 15);

        lblBar.setText("...");
        getContentPane().add(lblBar);
        lblBar.setBounds(20, 100, 360, 15);

        getContentPane().add(Bar);
        Bar.setBounds(20, 124, 360, 15);

    }//GEN-END:initComponents
    
    private void cmdExitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdExitActionPerformed
        // TODO add your handling code here:
        try {
            ((JFrame)getParent().getParent().getParent().getParent()).dispose();
        }
        catch(Exception e) {
            
        }
        
    }//GEN-LAST:event_cmdExitActionPerformed
    
    private void formMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_formMouseClicked
        // TODO add your handling code here:
        
    }//GEN-LAST:event_formMouseClicked
    
    private void cmdPrintActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdPrintActionPerformed
        // TODO add your handling code here:
        if ( ! Validate()) {
            return;
        }
        GenerateReport();
        
    }//GEN-LAST:event_cmdPrintActionPerformed
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JProgressBar Bar;
    private javax.swing.JComboBox cmbVoucherType;
    private javax.swing.JButton cmdExit;
    private javax.swing.JButton cmdPrint;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel lblBar;
    private javax.swing.JLabel lblTitle;
    private javax.swing.JTextField txtFromDate;
    private javax.swing.JTextField txtToDate;
    // End of variables declaration//GEN-END:variables
    
    private void GenerateReport() {
        
        new Thread() {
            public void run() {
                try {
                    
                    TReportWriter.SimpleDataProvider.TRow objRow;
                    TReportWriter.SimpleDataProvider.TTable objReportData=new TReportWriter.SimpleDataProvider.TTable();
                    String strSQL = "";
                    int Counter = 0;
                    objReportData.AddColumn("SR_NO");
                    objReportData.AddColumn("VOUCHER_NO");
                    objReportData.AddColumn("TABLE");
                    
                    
                    TReportWriter.SimpleDataProvider.TRow objOpeningRow=objReportData.newRow();
                    objOpeningRow.setValue("SR_NO","");
                    objOpeningRow.setValue("VOUCHER_NO","");
                    objOpeningRow.setValue("TABLE","");
                    
                    
                    int VoucherType = EITLERPGLOBAL.getComboCode(cmbVoucherType);
                    
                    if(VoucherType==0) {
                        strSQL = "SELECT COUNT(DISTINCT VOUCHER_NO,COMPANY_ID) FROM D_FIN_VOUCHER_HEADER " +
                        "WHERE VOUCHER_DATE>='"+ EITLERPGLOBAL.formatDateDB(txtFromDate.getText().trim()) +"' " +
                        "AND VOUCHER_TYPE<> '5' AND VOUCHER_DATE<='"+ EITLERPGLOBAL.formatDateDB(txtToDate.getText().trim()) +"' " +
                        "AND CANCELLED=0 AND BOOK_CODE<>'99' AND VOUCHER_NO NOT LIKE 'M%' ORDER BY COMPANY_ID,VOUCHER_NO"; //NOT
                    } else {
                        strSQL = "SELECT COUNT(DISTINCT VOUCHER_NO,COMPANY_ID) FROM D_FIN_VOUCHER_HEADER " +
                        "WHERE VOUCHER_DATE>='"+ EITLERPGLOBAL.formatDateDB(txtFromDate.getText().trim()) +"' " +
                        "AND VOUCHER_TYPE="+VoucherType+" AND VOUCHER_DATE<='"+ EITLERPGLOBAL.formatDateDB(txtToDate.getText().trim()) +"' " +
                        "AND CANCELLED=0 AND BOOK_CODE<>'99' AND VOUCHER_NO NOT LIKE 'M%' ORDER BY COMPANY_ID,VOUCHER_NO";
                    }
                    int Max = data.getIntValueFromDB(strSQL, FinanceGlobal.FinURL);
                    Bar.setStringPainted(true);
                    Bar.setVisible(true);
                    lblBar.setVisible(true);
                    Bar.setMinimum(0);
                    Bar.setMaximum(Max);
                    
                    if(VoucherType==0) {
                        strSQL = "SELECT DISTINCT VOUCHER_NO,COMPANY_ID FROM D_FIN_VOUCHER_HEADER " +
                        "WHERE VOUCHER_DATE>='"+ EITLERPGLOBAL.formatDateDB(txtFromDate.getText().trim()) +"' " +
                        "AND VOUCHER_TYPE<> '5' AND VOUCHER_DATE<='"+ EITLERPGLOBAL.formatDateDB(txtToDate.getText().trim()) +"' " +
                        "AND CANCELLED=0 AND BOOK_CODE<>'99' AND VOUCHER_NO NOT LIKE 'M%' ORDER BY COMPANY_ID,VOUCHER_NO"; //
                    }
                    else {
                        strSQL = "SELECT DISTINCT VOUCHER_NO,COMPANY_ID FROM D_FIN_VOUCHER_HEADER " +
                        "WHERE VOUCHER_DATE>='"+ EITLERPGLOBAL.formatDateDB(txtFromDate.getText().trim()) +"' " +
                        "AND VOUCHER_TYPE="+VoucherType+" AND VOUCHER_DATE<='"+ EITLERPGLOBAL.formatDateDB(txtToDate.getText().trim()) +"' " +
                        "AND CANCELLED=0 AND BOOK_CODE<>'99' AND VOUCHER_NO NOT LIKE 'M%' ORDER BY COMPANY_ID,VOUCHER_NO";
                    }
                    System.out.println(strSQL);
                    
                    
                    ResultSet rsData=data.getResult(strSQL,FinanceGlobal.FinURL);
                    rsData.first();
                    
                    
                    Counter=0;
                    Max = 0;
                    int UserID = EITLERPGLOBAL.gNewUserID;
                    if(rsData.getRow()>0) {
                        if(UserID==1) {
                            while(!rsData.isAfterLast()) {
                                String VoucherNo = UtilFunctions.getString(rsData,"VOUCHER_NO", "");
                                int CompanyID = UtilFunctions.getInt(rsData,"COMPANY_ID", 0);
                                String dbURL = clsFinYear.getDBURL(CompanyID,Integer.parseInt(EITLERPGLOBAL.getFinYearStartDate(EITLERPGLOBAL.formatDateDB(txtFromDate.getText().trim())).substring(0,4)));
                                Max++;
                                Bar.setValue(Max);
                                Bar.repaint();
                                lblBar.setText("Voucher No : " + VoucherNo);
                                if(!data.IsRecordExist("SELECT * FROM D_FIN_VOUCHER_DETAIL WHERE VOUCHER_NO='"+VoucherNo+"'",FinanceGlobal.FinURL)) {
                                    //System.out.println("CompanyID = " + CompanyID + " VoucherNo = "+VoucherNo+" does not exists in DETAIL");
                                    Counter++;
                                    objRow=objReportData.newRow();
                                    objRow.setValue("SR_NO",Integer.toString(Counter));
                                    objRow.setValue("VOUCHER_NO",VoucherNo);
                                    objRow.setValue("TABLE","D_FIN_VOUCHER_DETAIL");
                                    objReportData.AddRow(objRow);
                                }
                                if(!data.IsRecordExist("SELECT * FROM D_FIN_VOUCHER_DETAIL_EX WHERE VOUCHER_NO='"+VoucherNo+"'",FinanceGlobal.FinURL)) {
                                    //System.out.println("CompanyID = " + CompanyID + " VoucherNo = "+VoucherNo+" does not exists in DETAIL_EX");
                                    Counter++;
                                    objRow=objReportData.newRow();
                                    objRow.setValue("SR_NO",Integer.toString(Counter));
                                    objRow.setValue("VOUCHER_NO",VoucherNo);
                                    objRow.setValue("TABLE","D_FIN_VOUCHER_DETAIL_EX");
                                    objReportData.AddRow(objRow);
                                }
                                /*if(!data.IsRecordExist("SELECT * FROM D_COM_DOC_DATA WHERE DOC_NO='"+VoucherNo+"' ", dbURL)) {
                                    //System.out.println("CompanyID = " + CompanyID + " VoucherNo = "+VoucherNo+" does not exists in DOC_DATA");
                                    Counter++;
                                    objRow=objReportData.newRow();
                                    objRow.setValue("SR_NO",Integer.toString(Counter));
                                    objRow.setValue("VOUCHER_NO",VoucherNo);
                                    objRow.setValue("TABLE","D_COM_DOC_DATA");
                                    objReportData.AddRow(objRow);
                                }*/
                                rsData.next();
                            }
                            
                            
                        } else {
                            boolean Found=false;
                            String VoucherNo = "";
                            int CompanyID = 0;
                            while(!rsData.isAfterLast()) {
                                VoucherNo = UtilFunctions.getString(rsData,"VOUCHER_NO", "");
                                CompanyID = UtilFunctions.getInt(rsData,"COMPANY_ID", 0);
                                String dbURL = clsFinYear.getDBURL(CompanyID,Integer.parseInt(EITLERPGLOBAL.getFinYearStartDate(EITLERPGLOBAL.formatDateDB(txtFromDate.getText().trim())).substring(0,4)));
                                Found=false;
                                Max++;
                                Bar.setValue(Max);
                                Bar.repaint();
                                lblBar.setText("Voucher No : " + VoucherNo);
                                if(!data.IsRecordExist("SELECT * FROM D_FIN_VOUCHER_DETAIL WHERE VOUCHER_NO='"+VoucherNo+"'",FinanceGlobal.FinURL)) {
                                    //System.out.println("CompanyID = " + CompanyID + " VoucherNo = "+VoucherNo+" does not exists in DETAIL");
                                    Found=true;
                                }
                                if(!data.IsRecordExist("SELECT * FROM D_FIN_VOUCHER_DETAIL_EX WHERE VOUCHER_NO='"+VoucherNo+"'",FinanceGlobal.FinURL)) {
                                    //System.out.println("CompanyID = " + CompanyID + " VoucherNo = "+VoucherNo+" does not exists in DETAIL_EX");
                                    Found=true;
                                }
                                if(!data.IsRecordExist("SELECT * FROM D_COM_DOC_DATA WHERE DOC_NO='"+VoucherNo+"' ", dbURL)) {
                                    //System.out.println("CompanyID = " + CompanyID + " VoucherNo = "+VoucherNo+" does not exists in DOC_DATA");
                                    Found=true;
                                }
                                if(Found) {
                                    Counter++;
                                    objRow=objReportData.newRow();
                                    objRow.setValue("SR_NO",Integer.toString(Counter));
                                    objRow.setValue("VOUCHER_NO",VoucherNo);
                                    objRow.setValue("TABLE","");
                                    objReportData.AddRow(objRow);
                                }
                                rsData.next();
                            }
                        }
                    }
                    Bar.setVisible(false);
                    lblBar.setText("Completed...");
                    int Comp_ID = EITLERPGLOBAL.gCompanyID;
                    
                    HashMap Parameters=new HashMap();
                    Parameters.put("COMPANY_ID",Integer.toString(EITLERPGLOBAL.gCompanyID));
                    Parameters.put("FROM_DATE",txtFromDate.getText().trim());
                    Parameters.put("TO_DATE",txtToDate.getText().trim());
                    Parameters.put("SYS_DATE",EITLERPGLOBAL.getCurrentDate());
                    
                    objEngine.PreviewReport("http://"+EITLERPGLOBAL.HostIP+"/EITLERP/Reports/finance/rptCurrptedVouchers.rpt",Parameters,objReportData);
                    
                } catch(Exception e) {
                    
                }
            };
        }.start();
    }
    
    
    private void GenerateCombo() {
        
        //--- Generate Type Combo ------//
        ComboData aData=new ComboData();
        
        cmbVoucherTypeModel=new EITLComboModel();
        cmbVoucherType.removeAllItems();
        cmbVoucherType.setModel(cmbVoucherTypeModel);
        
        aData=new ComboData();
        aData.Code=0;
        aData.Text="ALL";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=1;
        aData.Text="PURCHASE JOURANAL VOUCHER";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=2;
        aData.Text="PAYMENT";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=3;
        aData.Text="DEBIT NOTE";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=4;
        aData.Text="CASH VOUCHER";
        cmbVoucherTypeModel.addElement(aData);
        
        /*aData=new ComboData();
        aData.Code=5;
        aData.Text="SALES_JOURNAL";
        cmbVoucherTypeModel.addElement(aData);*/
        
        aData=new ComboData();
        aData.Code=6;
        aData.Text="RECEIPT";
        cmbVoucherTypeModel.addElement(aData);
        
        
        aData=new ComboData();
        aData.Code=7;
        aData.Text="CREDIT NOTE";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=8;
        aData.Text="CASH RECEIPT VOUCHER";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=9;
        aData.Text="JOURNAL";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=10;
        aData.Text="PAYMENT 2";
        cmbVoucherTypeModel.addElement(aData);
        
        aData=new ComboData();
        aData.Code=11;
        aData.Text="LC JV";
        cmbVoucherTypeModel.addElement(aData);
        
        
    } private boolean Validate() {
        //Form level validations
        if(txtFromDate.getText().trim().equals("")) {
            JOptionPane.showMessageDialog(null,"Please enter from date");
            return false;
        } else if(!EITLERPGLOBAL.isDate(txtFromDate.getText())) {
            JOptionPane.showMessageDialog(null,"Invalid From Date in DD/MM/YYYY format.");
            return false;
        }
        
        if(txtToDate.getText().trim().equals("")) {
            JOptionPane.showMessageDialog(null,"Please enter To date");
            return false;
        } else if(!EITLERPGLOBAL.isDate(txtToDate.getText())) {
            JOptionPane.showMessageDialog(null,"Invalid To Date in DD/MM/YYYY format.");
            return false;
        }
        
        return true;
    }
}
