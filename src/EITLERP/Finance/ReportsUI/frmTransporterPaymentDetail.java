/*
 * frmTransporterPaymentDetail.java
 *
 * Created on September, 2015, 3:58 PM
 */

package EITLERP.Finance.ReportsUI;

/**
 *
 * @author  ashutosh
 */
import javax.swing.*;
import java.awt.*;
import EITLERP.*;
import java.util.*;
import javax.swing.table.*;
import javax.swing.event.*;
import javax.swing.text.*;
import java.awt.event.*;
import java.net.*;
import EITLERP.Utils.*;
import java.io.*;
import EITLERP.Purchase.*;
import EITLERP.Stores.*;
import java.sql.*;
import EITLERP.Finance.*;
import EITLERP.Production.ReportUI.*;
import java.io.File;

public class frmTransporterPaymentDetail extends javax.swing.JApplet {
    
    String ExtensionCodeFrom="";
    String ExtensionCodeTo="";
    String FromDate="";
    String ToDate="";
    
    private EITLTableModel DataModelPJV=new EITLTableModel();
    
    public clsExcelExporter export = new clsExcelExporter();
    
    
    private JDialog aDialog;
    
    
    /** Initializes the applet frmPaymentDetails */
    public void init() {
        setSize(715,527);
        initComponents();
        
    }
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        ExporttoExcelFileChooser = new javax.swing.JFileChooser();
        lblTitle = new javax.swing.JLabel();
        jLabel15 = new javax.swing.JLabel();
        txtExtCodeFrom = new javax.swing.JTextField();
        jLabel17 = new javax.swing.JLabel();
        txtExtCodeTo = new javax.swing.JTextField();
        cmdClose = new javax.swing.JButton();
        jLabel18 = new javax.swing.JLabel();
        txtFromDate = new javax.swing.JTextField();
        jLabel19 = new javax.swing.JLabel();
        txtToDate = new javax.swing.JTextField();
        Tab = new javax.swing.JTabbedPane();
        jPanel1 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jScrollPane5 = new javax.swing.JScrollPane();
        TablePJV = new javax.swing.JTable();
        cmdShowPJV = new javax.swing.JButton();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();
        lblExCodeNameFrom = new javax.swing.JLabel();
        lblExCodeNameTo = new javax.swing.JLabel();

        getContentPane().setLayout(null);

        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                formMouseClicked(evt);
            }
        });

        lblTitle.setBackground(new java.awt.Color(0, 102, 153));
        lblTitle.setForeground(java.awt.Color.white);
        lblTitle.setText("TRANSPORTER PAYMENT DETAILS");
        lblTitle.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        lblTitle.setOpaque(true);
        getContentPane().add(lblTitle);
        lblTitle.setBounds(1, 2, 780, 25);

        jLabel15.setText("Ext Code");
        getContentPane().add(jLabel15);
        jLabel15.setBounds(60, 40, 60, 20);

        txtExtCodeFrom.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtExtCodeFromFocusLost(evt);
            }
        });

        getContentPane().add(txtExtCodeFrom);
        txtExtCodeFrom.setBounds(130, 40, 60, 19);

        jLabel17.setText("To");
        getContentPane().add(jLabel17);
        jLabel17.setBounds(100, 70, 20, 15);

        txtExtCodeTo.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtExtCodeToFocusLost(evt);
            }
        });

        getContentPane().add(txtExtCodeTo);
        txtExtCodeTo.setBounds(130, 70, 60, 19);

        cmdClose.setText("Close");
        cmdClose.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdCloseActionPerformed(evt);
            }
        });

        getContentPane().add(cmdClose);
        cmdClose.setBounds(540, 530, 130, 25);

        jLabel18.setText("From Date");
        getContentPane().add(jLabel18);
        jLabel18.setBounds(50, 100, 70, 20);

        getContentPane().add(txtFromDate);
        txtFromDate.setBounds(130, 100, 80, 19);

        jLabel19.setText("To");
        getContentPane().add(jLabel19);
        jLabel19.setBounds(220, 100, 20, 20);

        getContentPane().add(txtToDate);
        txtToDate.setBounds(250, 100, 80, 19);

        jPanel1.setLayout(null);

        jPanel1.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(0, 0, 0)));
        jPanel4.setLayout(null);

        jPanel4.setBorder(new javax.swing.border.EtchedBorder());
        TablePJV.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jScrollPane5.setViewportView(TablePJV);

        jPanel4.add(jScrollPane5);
        jScrollPane5.setBounds(5, 5, 630, 270);

        jPanel1.add(jPanel4);
        jPanel4.setBounds(6, 34, 640, 280);

        cmdShowPJV.setText("Show");
        cmdShowPJV.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdShowPJVActionPerformed(evt);
            }
        });

        jPanel1.add(cmdShowPJV);
        cmdShowPJV.setBounds(8, 8, 100, 20);

        Tab.addTab("List", jPanel1);

        getContentPane().add(Tab);
        Tab.setBounds(10, 150, 660, 360);

        jButton1.setText("Show Voucher");
        jButton1.setMargin(new java.awt.Insets(2, 2, 2, 2));
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        getContentPane().add(jButton1);
        jButton1.setBounds(20, 530, 98, 25);

        jButton2.setText("Export to Excel");
        jButton2.setMargin(new java.awt.Insets(2, 2, 2, 2));
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        getContentPane().add(jButton2);
        jButton2.setBounds(130, 530, 110, 25);

        lblExCodeNameFrom.setText("...");
        getContentPane().add(lblExCodeNameFrom);
        lblExCodeNameFrom.setBounds(210, 40, 260, 15);

        lblExCodeNameTo.setText("...");
        getContentPane().add(lblExCodeNameTo);
        lblExCodeNameTo.setBounds(210, 70, 260, 15);

    }//GEN-END:initComponents

    private void txtExtCodeToFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtExtCodeToFocusLost
        lblExCodeNameTo.setText(data.getStringValueFromDB("SELECT EX_ACCOUNT_NAME FROM D_FIN_EX_ACCOUNT_MASTER WHERE EX_ACCOUNT_CODE='"+txtExtCodeTo.getText()+"'",FinanceGlobal.FinURL));
    }//GEN-LAST:event_txtExtCodeToFocusLost

    private void txtExtCodeFromFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtExtCodeFromFocusLost
        
        lblExCodeNameFrom.setText(data.getStringValueFromDB("SELECT EX_ACCOUNT_NAME FROM D_FIN_EX_ACCOUNT_MASTER WHERE EX_ACCOUNT_CODE='"+txtExtCodeFrom.getText()+"'",FinanceGlobal.FinURL));
    }//GEN-LAST:event_txtExtCodeFromFocusLost

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        try{
        File file;        
        ExporttoExcelFileChooser.setDialogTitle("Enter Excel File Name");
        ExporttoExcelFileChooser.setFileSelectionMode(JFileChooser.APPROVE_OPTION);
        int returnVal = ExporttoExcelFileChooser.showSaveDialog(frmTransporterPaymentDetail.this);
        if ( returnVal == JFileChooser.APPROVE_OPTION) {
            file = ExporttoExcelFileChooser.getSelectedFile();
            export.fillData(TablePJV,new File(file+".xls"));
            JOptionPane.showMessageDialog(null," Excel File Saved at : "+ file+".xls","Message",JOptionPane.INFORMATION_MESSAGE);
        }           
            
        }
        catch(Exception ex)
        {
            ex.printStackTrace();
        }     
    }//GEN-LAST:event_jButton2ActionPerformed
    
    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        try {
            if(TablePJV.getSelectedRow()>=0) {
                String DocNo=DataModelPJV.getValueByVariable("B.VOUCHER_NO", TablePJV.getSelectedRow());
                System.out.println(DocNo);
                clsVoucher.OpenVoucher(DocNo, null);
            }
            
        } catch(Exception e) {
            
        }
    }//GEN-LAST:event_jButton1ActionPerformed
    
    private void formMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_formMouseClicked
        // TODO add your handling code here:
    }//GEN-LAST:event_formMouseClicked
    
    private void cmdCloseActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdCloseActionPerformed
        // TODO add your handling code here:
        try {
            ((JFrame)getParent().getParent().getParent().getParent()).dispose();
        }
        catch(Exception e) {
            
        }
        
        try {
            aDialog.dispose();
        }
        catch(Exception e) {
            
        }
        
        
    }//GEN-LAST:event_cmdCloseActionPerformed
    
    private void cmdShowPJVActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdShowPJVActionPerformed
        // TODO add your handling code here:
        GenerateGridPJV();
    }//GEN-LAST:event_cmdShowPJVActionPerformed
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JFileChooser ExporttoExcelFileChooser;
    private javax.swing.JTabbedPane Tab;
    private javax.swing.JTable TablePJV;
    private javax.swing.JButton cmdClose;
    private javax.swing.JButton cmdShowPJV;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel17;
    private javax.swing.JLabel jLabel18;
    private javax.swing.JLabel jLabel19;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JScrollPane jScrollPane5;
    private javax.swing.JLabel lblExCodeNameFrom;
    private javax.swing.JLabel lblExCodeNameTo;
    private javax.swing.JLabel lblTitle;
    private javax.swing.JTextField txtExtCodeFrom;
    private javax.swing.JTextField txtExtCodeTo;
    private javax.swing.JTextField txtFromDate;
    private javax.swing.JTextField txtToDate;
    // End of variables declaration//GEN-END:variables
    
    private void FormatGridPJV() {
        try {
            
            DataModelPJV=new EITLTableModel();
            TablePJV.removeAll();
            TablePJV.setModel(DataModelPJV);
            
            TablePJV.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);
            
            DataModelPJV.addColumn("Sr."); //0 - Read Only
            DataModelPJV.addColumn("Extension Code"); //8
            DataModelPJV.addColumn("Voucher No."); //1
            DataModelPJV.addColumn("Voucher Date"); //2 //Read Only
            DataModelPJV.addColumn("Legacy No"); //3
            DataModelPJV.addColumn("Account Code"); //3
            DataModelPJV.addColumn("Account Name"); //4
            DataModelPJV.addColumn("Gross Amt"); //5
            DataModelPJV.addColumn("Applicable Amt"); //6
            DataModelPJV.addColumn("Percentage"); //4
            DataModelPJV.addColumn("TDS Amt"); //5
            
            DataModelPJV.SetVariable(0,"cnt");
            DataModelPJV.SetVariable(1,"SUBSTRING(MAIN_ACCOUNT_CODE,8)");
            DataModelPJV.SetVariable(2,"B.VOUCHER_NO");
            
            
            DataModelPJV.TableReadOnly(true);
        }
        catch(Exception e) {
            e.printStackTrace();
        }
    }
    
    
    private void GenerateGridPJV() {
        
        try {
            HashMap List=new HashMap();
            
            FormatGridPJV();
            
            ExtensionCodeFrom=txtExtCodeFrom.getText().toString();
            ExtensionCodeTo=txtExtCodeTo.getText().toString();
            FromDate=EITLERPGLOBAL.formatDateDB(txtFromDate.getText());
            ToDate=EITLERPGLOBAL.formatDateDB(txtToDate.getText());
            //String sql="SELECT DISTINCT B.VOUCHER_NO FROM D_FIN_VOUCHER_DETAIL B,D_FIN_VOUCHER_HEADER A WHERE B.MAIN_ACCOUNT_CODE LIKE ('%.%') AND A.VOUCHER_NO=B.VOUCHER_NO AND A.VOUCHER_DATE>='"+FromDate+"' AND A.VOUCHER_DATE<='"+ToDate+"'";
            String sql="";
            sql+="SELECT DISTINCT B.VOUCHER_NO, VOUCHER_DATE,SUBSTRING(MAIN_ACCOUNT_CODE,8),A.LEGACY_NO,SUBSTRING(MAIN_ACCOUNT_CODE,1,6) AS ACCOUNT_CODE FROM D_FIN_VOUCHER_DETAIL B,D_FIN_VOUCHER_HEADER A WHERE B.MAIN_ACCOUNT_CODE LIKE ('%.%') AND A.VOUCHER_NO=B.VOUCHER_NO ";
            if(!txtFromDate.getText().trim().equals("")){
                if(!txtToDate.getText().trim().equals("")){
                    sql+=" AND A.VOUCHER_DATE>='"+FromDate+"' AND A.VOUCHER_DATE<='"+ToDate+"' ";
                }
                else{
                    sql+=" AND A.VOUCHER_DATE>='"+FromDate+"' ";
                }
                
            }
            else{
                if(!txtToDate.getText().trim().equals("")){
                    sql+=" AND A.VOUCHER_DATE<='"+ToDate+"' ";
                }
            }
            if(!txtExtCodeFrom.getText().trim().equals("")){
                if(!txtExtCodeTo.getText().trim().equals("")){
                    sql+=" AND SUBSTRING(MAIN_ACCOUNT_CODE,8)>='"+ExtensionCodeFrom+"' AND SUBSTRING(MAIN_ACCOUNT_CODE,8)<='"+ExtensionCodeTo+"' ";
                }
                else{
                    sql+=" AND SUBSTRING(MAIN_ACCOUNT_CODE,8)>='"+ExtensionCodeFrom+"' ";
                }
            }
            else{
                if(!txtExtCodeTo.getText().trim().equals("")){
                    sql+=" AND SUBSTRING(MAIN_ACCOUNT_CODE,8)<='"+ExtensionCodeTo+"' ";
                }
            }
            sql+=" ORDER BY SUBSTRING(MAIN_ACCOUNT_CODE,8),VOUCHER_DATE,LEGACY_NO ";
            //System.out.println(sql);
            ResultSet Tmp=data.getResult(sql,FinanceGlobal.FinURL);
            Tmp.first();
            
            if(Tmp.getRow()>0) {
                int cnt=0;
                while(!Tmp.isAfterLast()) {
                    
                    String VoucherNo=UtilFunctions.getString(Tmp,"B.VOUCHER_NO"," ");
                    
                    ResultSet rsTemp;
                    String strSQL="";
                    //strSQL+="SELECT A.VOUCHER_DATE,A.LEGACY_NO,B.* FROM D_FIN_VOUCHER_HEADER A,D_FIN_VOUCHER_DETAIL B WHERE B.MAIN_ACCOUNT_CODE LIKE ('%.%') AND A.VOUCHER_NO=B.VOUCHER_NO"; //AND B.VOUCHER_NO='CS153000978'";  //ORDER BY SUBSTRING(B.MAIN_ACCOUNT_CODE,8)";
                    //strSQL+="SELECT SUBSTRING(B.MAIN_ACCOUNT_CODE,8) AS EXT_CODE,A.VOUCHER_NO,A.VOUCHER_DATE,A.LEGACY_NO,SUBSTRING(B.MAIN_ACCOUNT_CODE,1,6) AS ACCOUNT_CODE,B.AMOUNT AS TDS,B.APPLICABLE_AMOUNT,B.PERCENTAGE FROM D_FIN_VOUCHER_HEADER A, D_FIN_VOUCHER_DETAIL B WHERE A.VOUCHER_NO=B.VOUCHER_NO AND B.MAIN_ACCOUNT_CODE LIKE ('%.%') AND A.VOUCHER_DATE>='"+FromDate+"' AND A.VOUCHER_DATE<='"+ToDate+"'";
                    strSQL+="SELECT AMOUNT AS TDS,APPLICABLE_AMOUNT,PERCENTAGE FROM D_FIN_VOUCHER_DETAIL WHERE VOUCHER_NO='"+VoucherNo+"' AND MAIN_ACCOUNT_CODE='127171'  AND EFFECT='C'";
                    rsTemp=data.getResult(strSQL,FinanceGlobal.FinURL);
                    
                    if(rsTemp.getRow()>0) {
                        while(!rsTemp.isAfterLast()) {
                            cnt++;
                            Object[] rowData=new Object[12];
                            rowData[0]=Integer.toString(cnt);
                            //rowData[1]=rsTemp.getString("B.MAIN_ACCOUNT_CODE").toString().substring(7);
                            rowData[1]=UtilFunctions.getString(Tmp,"SUBSTRING(MAIN_ACCOUNT_CODE,8)"," ");
                            rowData[2]=VoucherNo;
                            rowData[3]=EITLERPGLOBAL.formatDate(UtilFunctions.getString(Tmp,"VOUCHER_DATE","0000-00-00"));
                            rowData[4]=UtilFunctions.getString(Tmp,"A.LEGACY_NO"," ");
                            rowData[5]=UtilFunctions.getString(Tmp,"ACCOUNT_CODE"," ");
                            rowData[6]=clsAccount.getAccountName(UtilFunctions.getString(Tmp,"ACCOUNT_CODE"," "),"");
                            rowData[7]=Double.toString(data.getDoubleValueFromDB("SELECT SUM(AMOUNT) FROM D_FIN_VOUCHER_DETAIL WHERE VOUCHER_NO='"+VoucherNo+"' AND EFFECT='D'",FinanceGlobal.FinURL));
                            rowData[8]=rsTemp.getString("APPLICABLE_AMOUNT");
                            rowData[9]=rsTemp.getString("PERCENTAGE");
                            rowData[10]=rsTemp.getString("TDS");
                            
                            DataModelPJV.addRow(rowData);
                            rsTemp.next();
                        }
                    }
                    else{
                        cnt++;
                        Object[] rowData=new Object[12];
                        rowData[0]=Integer.toString(cnt);
                        //rowData[1]=rsTemp.getString("B.MAIN_ACCOUNT_CODE").toString().substring(7);
                        rowData[1]=UtilFunctions.getString(Tmp,"SUBSTRING(MAIN_ACCOUNT_CODE,8)"," ");
                        rowData[2]=VoucherNo;
                        rowData[3]=EITLERPGLOBAL.formatDate(UtilFunctions.getString(Tmp,"VOUCHER_DATE","0000-00-00"));
                        rowData[4]=UtilFunctions.getString(Tmp,"A.LEGACY_NO"," ");
                        rowData[5]=UtilFunctions.getString(Tmp,"ACCOUNT_CODE"," ");
                        rowData[6]=clsAccount.getAccountName(UtilFunctions.getString(Tmp,"ACCOUNT_CODE"," "),"");
                        rowData[7]=Double.toString(data.getDoubleValueFromDB("SELECT SUM(AMOUNT) FROM D_FIN_VOUCHER_DETAIL WHERE VOUCHER_NO='"+VoucherNo+"' AND EFFECT='D'",FinanceGlobal.FinURL));
                        rowData[8]="0";
                        rowData[9]="0";
                        rowData[10]="0";
                        
                        DataModelPJV.addRow(rowData);
                    }
                    Tmp.next();
                }
            }
        }
        catch(Exception e) {
            e.printStackTrace();
        }
    }
    
    private Frame findParentFrame(JApplet pApplet) {
        Container c = (Container) pApplet;
        while(c != null) {
            if (c instanceof Frame)
                return (Frame)c;
            
            c = c.getParent();
        }
        return (Frame)null;
    }
    
    
    public void ShowDialog() {
        try {
            setSize(715,527);
            
            Frame f=findParentFrame(this);
            
            initComponents();
            //txtPartyCode.setText(this.PartyCode);
            //txtPartyName.setText(clsPartyMaster.getAccountName("",txtPartyCode.getText()));
            
            
            GenerateGridPJV();
            
            aDialog=new JDialog(f,"Party Payable Details",true);
            
            aDialog.getContentPane().add("Center",this);
            Dimension appletSize = this.getSize();
            aDialog.setSize(appletSize);
            aDialog.setResizable(false);
            
            //Place it to center of the screen
            Dimension screenSize=Toolkit.getDefaultToolkit().getScreenSize();
            aDialog.setLocation((int)(screenSize.width-appletSize.getWidth())/2,(int)(screenSize.height-appletSize.getHeight())/2);
            
            aDialog.setDefaultCloseOperation(javax.swing.JDialog.DISPOSE_ON_CLOSE);
            aDialog.show();
        }
        catch(Exception e) {
        }
    }
    
    
}
