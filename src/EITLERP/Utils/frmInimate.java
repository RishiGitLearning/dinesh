/*
 * frmInimate.java
 *
 * Created on December 31, 2004, 11:02 AM
 */

package EITLERP.Utils;

/**
 *
 * @author  root
 */

import javax.swing.*;
import java.util.*;
import EITLERP.*;
import java.io.*;
import EITLERP.JavaMail.*;
import java.awt.Frame;
import java.awt.*;


public class frmInimate extends javax.swing.JApplet {

    private JDialog aDialog;
    public boolean Cancelled=true;

public static void main(String[] args)    
{
    frmInimate newObj=new frmInimate();
    newObj.ShowForm();
}
    

    public void init() {
        initComponents();
    }
    
    
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        lblTitle = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        lblStatus = new javax.swing.JLabel();
        cmdStart = new javax.swing.JButton();
        cmdExit = new javax.swing.JButton();
        
        getContentPane().setLayout(null);
        
        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                formMouseClicked(evt);
            }
        });
        
        lblTitle.setBackground(new java.awt.Color(0, 102, 153));
        lblTitle.setForeground(java.awt.Color.white);
        lblTitle.setText(" INTIMATION TO THE USERS");
        lblTitle.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        lblTitle.setOpaque(true);
        getContentPane().add(lblTitle);
        lblTitle.setBounds(1, 4, 804, 25);
        
        jPanel1.setLayout(null);
        
        jPanel1.setBorder(new javax.swing.border.EtchedBorder());
        jLabel1.setText("Status");
        jPanel1.add(jLabel1);
        jLabel1.setBounds(12, 8, 45, 15);
        
        lblStatus.setText("...");
        jPanel1.add(lblStatus);
        lblStatus.setBounds(14, 39, 356, 15);
        
        getContentPane().add(jPanel1);
        jPanel1.setBounds(9, 81, 380, 74);
        
        cmdStart.setText("Start");
        cmdStart.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdStartActionPerformed(evt);
            }
        });
        
        getContentPane().add(cmdStart);
        cmdStart.setBounds(159, 167, 97, 25);
        
        cmdExit.setText("Exit");
        cmdExit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdExitActionPerformed(evt);
            }
        });
        
        getContentPane().add(cmdExit);
        cmdExit.setBounds(270, 167, 106, 25);
        
    }//GEN-END:initComponents

    private void cmdExitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdExitActionPerformed
        // TODO add your handling code here:
        try
        {
         aDialog.dispose();   
        }
        catch(Exception e)
        {
          
        }
    }//GEN-LAST:event_cmdExitActionPerformed

    private void formMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_formMouseClicked
        // TODO add your handling code here:
        
    }//GEN-LAST:event_formMouseClicked
    
    private void cmdStartActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdStartActionPerformed
        // TODO add your handling code here:
        
        new Thread() {
            
            public void run() {
                HashMap List=new HashMap();
                HashMap userList=new HashMap();
                
                int tmpCurrentUserID=EITLERPGLOBAL.gUserID;
                
                int TotalPendingCount=0;
                String EMailID="";
                String EMailText="";
                
                try {
                    
                    frmPendingApprovals ObjPending=new frmPendingApprovals();
                    ObjPending.init();
                    ObjPending.start();
                    
                    
                    clsUser tmpObj=new clsUser();
                    userList=tmpObj.getList("");
                    
                    
                    for(int u=1;u<=userList.size();u++) {
                        
                        clsUser ObjUser=(clsUser)userList.get(Integer.toString(u));
                        int UserID=(int)ObjUser.getAttribute("USER_ID").getVal();
                        String UserName=(String)ObjUser.getAttribute("USER_NAME").getObj();
                        
                        lblStatus.setText("Processing "+UserName);
                        lblStatus.repaint();
                        
                        EMailID=clsUser.getEMailID(EITLERPGLOBAL.gCompanyID, UserID);
                        
                        //Get the pending count
                        TotalPendingCount=0;
                        
                        String strCondition=" WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID+" ORDER BY MODULE_ID";
                        List=clsModules.getList(strCondition);
                        for(int i=1;i<=List.size();i++) {
                            clsModules ObjModules=(clsModules) List.get(Integer.toString(i));
                            //Check that Module Access Rights are given
                            int ModuleID=(int)ObjModules.getAttribute("MODULE_ID").getVal();
                            
                            EITLERPGLOBAL.gUserID=UserID; //Bcz. all module refer to this global variable.
                            
                            TotalPendingCount+=ObjPending.GetCount(ModuleID);
                        }
                        
                        
                        
                        if(TotalPendingCount>0&&(!EMailID.trim().equals(""))) {
                            //Create a Text file
                            
                            EMailText="";
                            
                            BufferedWriter aFile=new BufferedWriter(new FileWriter(new File("/root/"+UserName+".txt")));
                            
                            aFile.write("Dear sir/madam");
                            EMailText+="For "+UserName;
                            EMailText+=new String("\n");
                            EMailText+="Dear sir/madam";
                            
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("You have following documents waiting for your approval");
                            EMailText+="You have following documents waiting for your approval";
                            
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            
                            strCondition=" WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID+" ORDER BY MODULE_ID";
                            List=clsModules.getList(strCondition);
                            for(int i=1;i<=List.size();i++) {
                                clsModules ObjModules=(clsModules) List.get(Integer.toString(i));
                                //Check that Module Access Rights are given
                                int ModuleID=(int)ObjModules.getAttribute("MODULE_ID").getVal();
                                
                                EITLERPGLOBAL.gUserID=UserID; //Bcz. all module refer to this global variable.
                                
                                int Count= ObjPending.GetCount(ModuleID);
                                String ModuleName=clsModules.getModuleName(EITLERPGLOBAL.gCompanyID,ModuleID);
                                
                                if(Count>0) {
                                    aFile.write(ModuleName+" - "+Count);
                                    EMailText+=ModuleName+" - "+Count;
                                    
                                    aFile.newLine();
                                    EMailText+=new String("\n");
                                }
                            }
                            
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("Kindly approve these documents.");
                            EMailText+="Kindly approve these documents.";
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("EITLERP System ");
                            EMailText+="EITLERP System ";
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("NOTE : DO NOT REPLY TO THIS MAIL. IT IS AUTOMATICALLY GENERATED EMAIL FROM EITLERP SYSTEM");
                            EMailText+="NOTE : DO NOT REPLY TO THIS MAIL. IT IS AUTOMATICALLY GENERATED EMAIL FROM EITLERP SYSTEM";
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.close();
                            
                            if(!EMailID.trim().equals("")) {
                                lblStatus.setText("Sending Mail");
                                lblStatus.repaint();
                                try
                                {
                                JMail.SendMail(EITLERPGLOBAL.SMTPHostIP,"eitlerp@dineshmills.com", EMailID,EMailText, "EITLERP - Documents waiting for your approval", "kpshah@dineshmills.com");
                                }
                                catch(Exception e)
                                {
                                  JOptionPane.showMessageDialog(null,e.getMessage());  
                                }
                            }
                            
                            
                        }
                    }
                    
                    
                    EITLERPGLOBAL.gUserID=tmpCurrentUserID;
                    
                }
                catch(Exception e) {
                    e.printStackTrace();
                    EITLERPGLOBAL.gUserID=tmpCurrentUserID;
                }
            };
        }.start();
        
    }//GEN-LAST:event_cmdStartActionPerformed
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton cmdExit;
    private javax.swing.JButton cmdStart;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JLabel lblStatus;
    private javax.swing.JLabel lblTitle;
    // End of variables declaration//GEN-END:variables


    public void StartProcess()
    {
        
        
        new Thread() {
            
            public void run() {
                HashMap List=new HashMap();
                HashMap userList=new HashMap();
                
                int TotalPendingCount=0;
                String EMailID="";
                String EMailText="";
                
                data.OpenGlobalConnection();
                
                try {
                    
                    frmPendingApprovals ObjPending=new frmPendingApprovals();
                    ObjPending.init();
                    ObjPending.start();
                    
                    
                    clsUser tmpObj=new clsUser();
                    userList=tmpObj.getList("");
                    
                    
                    for(int u=1;u<=userList.size();u++) {
                        
                        clsUser ObjUser=(clsUser)userList.get(Integer.toString(u));
                        int UserID=(int)ObjUser.getAttribute("USER_ID").getVal();
                        String UserName=(String)ObjUser.getAttribute("USER_NAME").getObj();
                        
                        lblStatus.setText("Processing "+UserName);
                        lblStatus.repaint();
                        
                        EMailID=clsUser.getEMailID(EITLERPGLOBAL.gCompanyID, UserID);
                        
                        //Get the pending count
                        TotalPendingCount=0;
                        
                        String strCondition=" WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID+" ORDER BY MODULE_ID";
                        List=clsModules.getList(strCondition);
                        for(int i=1;i<=List.size();i++) {
                            clsModules ObjModules=(clsModules) List.get(Integer.toString(i));
                            //Check that Module Access Rights are given
                            int ModuleID=(int)ObjModules.getAttribute("MODULE_ID").getVal();
                            
                            EITLERPGLOBAL.gUserID=UserID; //Bcz. all module refer to this global variable.
                            
                            TotalPendingCount+=ObjPending.GetCount(ModuleID);
                        }
                        
                        
                        
                        if(TotalPendingCount>0&&(!EMailID.trim().equals(""))) {
                            //Create a Text file
                            
                            EMailText="";
                            
                            BufferedWriter aFile=new BufferedWriter(new FileWriter(new File("/root/"+UserName+".txt")));
                            
                            aFile.write("Dear sir/madam");
                            EMailText+="For "+UserName;
                            EMailText+=new String("\n");
                            EMailText+="Dear sir/madam";
                            
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("You have following documents waiting for your approval");
                            EMailText+="You have following documents waiting for your approval";
                            
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            
                            strCondition=" WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID+" ORDER BY MODULE_ID";
                            List=clsModules.getList(strCondition);
                            for(int i=1;i<=List.size();i++) {
                                clsModules ObjModules=(clsModules) List.get(Integer.toString(i));
                                //Check that Module Access Rights are given
                                int ModuleID=(int)ObjModules.getAttribute("MODULE_ID").getVal();
                                
                                EITLERPGLOBAL.gUserID=UserID; //Bcz. all module refer to this global variable.
                                
                                int Count= ObjPending.GetCount(ModuleID);
                                String ModuleName=clsModules.getModuleName(EITLERPGLOBAL.gCompanyID,ModuleID);
                                
                                if(Count>0) {
                                    aFile.write(ModuleName+" - "+Count);
                                    EMailText+=ModuleName+" - "+Count;
                                    
                                    aFile.newLine();
                                    EMailText+=new String("\n");
                                }
                            }
                            
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("Kindly approve these documents.");
                            EMailText+="Kindly approve these documents.";
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("EITLERP System ");
                            EMailText+="EITLERP System ";
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.write("NOTE : DO NOT REPLY TO THIS MAIL. IT IS AUTOMATICALLY GENERATED EMAIL FROM EITLERP SYSTEM");
                            EMailText+="NOTE : DO NOT REPLY TO THIS MAIL. IT IS AUTOMATICALLY GENERATED EMAIL FROM EITLERP SYSTEM";
                            aFile.newLine();
                            EMailText+=new String("\n");
                            aFile.close();
                            
                            if(!EMailID.trim().equals("")) {
                                lblStatus.setText("Sending Mail");
                                lblStatus.repaint();
                                try
                                {
                                JMail.SendMail(EITLERPGLOBAL.SMTPHostIP,"eitlerp@dineshmills.com", EMailID,EMailText, "EITLERP - Documents waiting for your approval","eitl");
                                }
                                catch(Exception e)
                                {
                                  JOptionPane.showMessageDialog(null,e.getMessage());  
                                }
                            }
                            
                            
                        }
                    }
                    
                    
                }
                catch(Exception e) {
                    e.printStackTrace();
                }
            };
        }.start();
        
    }

    
    public boolean ShowForm() {
        try {

            
            setSize(425,250);

            this.init();
            StartProcess();
            Frame f=findParentFrame(this);
            
            aDialog=new JDialog(f,"Intimation",true);
            
            aDialog.getContentPane().add("Center",this);
            Dimension appletSize = this.getSize();
            aDialog.setSize(appletSize);
            aDialog.setResizable(false);
          
            //Place it to center of the screen
            Dimension screenSize=Toolkit.getDefaultToolkit().getScreenSize();
            aDialog.setLocation((int)(screenSize.width-appletSize.getWidth())/2,(int)(screenSize.height-appletSize.getHeight())/2);
            
            aDialog.setDefaultCloseOperation(javax.swing.JDialog.DISPOSE_ON_CLOSE);
            aDialog.show();
        }
        catch(Exception e) {
        }
        return !Cancelled;
    }
    
    //Recurses through the hierarchy of classes
    //until it finds Frame
    private Frame findParentFrame(JApplet pApplet) {
        Container c = (Container) pApplet;
        while(c != null) {
            if (c instanceof Frame)
                return (Frame)c;
            
            c = c.getParent();
        }
        return (Frame)null;
    }

    
}
