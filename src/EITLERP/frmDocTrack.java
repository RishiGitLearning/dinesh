/*
 * frmDocTrack.java
 *
 * Created on July 17, 2004, 4:44 PM
 */

package EITLERP;
 
/**
 * 
 * @author  nrpithva
 */
import javax.swing.*;
import java.awt.*;
import java.sql.*;
import java.net.*;
import java.util.*;
import javax.swing.table.*;
 
public class frmDocTrack extends javax.swing.JApplet {
    
    private EITLTableModel DataModel;
    private EITLComboModel cmbModuleModel;
    private EITLComboModel cmbDeptModel;
    private String DocNo="";
    private int SelModuleID=0;
    private int SelDeptID=0;
    private HashMap History=new HashMap();
    
    /** Initializes the applet frmDocTrack */
    public void init() {
        initComponents();
        GenerateCombo();
    }
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        cmbModule = new javax.swing.JComboBox();
        jLabel3 = new javax.swing.JLabel();
        txtDocNo = new javax.swing.JTextField();
        cmdShow = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();
        jLabel4 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        Table = new javax.swing.JTable();
        cmdOpen = new javax.swing.JButton();
        jLabel5 = new javax.swing.JLabel();
        chkDept = new javax.swing.JCheckBox();
        cmbDept = new javax.swing.JComboBox();

        getContentPane().setLayout(null);

        jLabel1.setBackground(new java.awt.Color(0, 102, 153));
        jLabel1.setForeground(java.awt.Color.white);
        jLabel1.setText(" DOCUMENT TRACKING");
        jLabel1.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jLabel1.setOpaque(true);
        getContentPane().add(jLabel1);
        jLabel1.setBounds(0, 2, 650, 25);

        jLabel2.setText("Module ");
        getContentPane().add(jLabel2);
        jLabel2.setBounds(14, 76, 62, 15);

        getContentPane().add(cmbModule);
        cmbModule.setBounds(86, 72, 250, 24);

        jLabel3.setText("Doc. No.");
        getContentPane().add(jLabel3);
        jLabel3.setBounds(16, 110, 62, 15);

        getContentPane().add(txtDocNo);
        txtDocNo.setBounds(86, 108, 144, 19);

        cmdShow.setText("Show");
        cmdShow.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdShowActionPerformed(evt);
            }
        });

        getContentPane().add(cmdShow);
        cmdShow.setBounds(242, 108, 90, 25);

        jPanel1.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(0, 0, 0)));
        getContentPane().add(jPanel1);
        jPanel1.setBounds(10, 144, 466, 4);

        jLabel4.setText("List of documents created based on above document no.");
        getContentPane().add(jLabel4);
        jLabel4.setBounds(8, 154, 378, 15);

        Table.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jScrollPane1.setViewportView(Table);

        getContentPane().add(jScrollPane1);
        jScrollPane1.setBounds(10, 182, 458, 172);

        cmdOpen.setText("Open Document");
        getContentPane().add(cmdOpen);
        cmdOpen.setBounds(326, 366, 142, 25);

        jLabel5.setText("Double click in table to jump to next level.");
        getContentPane().add(jLabel5);
        jLabel5.setBounds(10, 362, 290, 15);

        chkDept.setText("Dept");
        chkDept.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                chkDeptItemStateChanged(evt);
            }
        });

        getContentPane().add(chkDept);
        chkDept.setBounds(10, 42, 72, 23);

        cmbDept.setEnabled(false);
        getContentPane().add(cmbDept);
        cmbDept.setBounds(86, 44, 250, 24);

    }//GEN-END:initComponents

    private void cmdShowActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdShowActionPerformed
        // TODO add your handling code here:
        GenerateGrid();
    }//GEN-LAST:event_cmdShowActionPerformed

    private void chkDeptItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_chkDeptItemStateChanged
        // TODO add your handling code here:
        if(chkDept.isSelected())
        {
            cmbDept.setEnabled(true);
        }
        else
        {
            cmbDept.setEnabled(false);
        }
    }//GEN-LAST:event_chkDeptItemStateChanged
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Table;
    private javax.swing.JCheckBox chkDept;
    private javax.swing.JComboBox cmbDept;
    private javax.swing.JComboBox cmbModule;
    private javax.swing.JButton cmdOpen;
    private javax.swing.JButton cmdShow;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTextField txtDocNo;
    // End of variables declaration//GEN-END:variables

    private void GenerateCombo() {
        //Generates Combo Boxes
        HashMap List=new HashMap();
        String strCondition="";
        
        //----- Generate cmbType ------- //
        cmbModuleModel=new EITLComboModel();
        cmbModule.removeAllItems();
        cmbModule.setModel(cmbModuleModel);
        
        strCondition=" WHERE COMPANY_ID="+Long.toString(EITLERPGLOBAL.gCompanyID)+" ORDER BY MODULE_ID";
        
        List=clsModules.getList(strCondition);
        for(int i=1;i<=List.size();i++) {
            clsModules ObjModules=(clsModules) List.get(Integer.toString(i));
            //Check that Module Access Rights are given
            int ModuleID=(int)ObjModules.getAttribute("MODULE_ID").getVal();
            int MenuID=clsMenu.getMenuIDFromModule(EITLERPGLOBAL.gCompanyID, ModuleID);
            
            if(clsUser.IsFunctionGranted(EITLERPGLOBAL.gCompanyID, EITLERPGLOBAL.gUserID, 0,MenuID)) {
                ComboData aData=new ComboData();
                aData.Text=(String) ObjModules.getAttribute("MODULE_DESC").getObj();
                aData.Code=(int) ObjModules.getAttribute("MODULE_ID").getVal();
                cmbModuleModel.addElement(aData);
            }
        }

        //----- Generate cmbType ------- //
        cmbDeptModel=new EITLComboModel();
        cmbDept.removeAllItems();
        cmbDept.setModel(cmbDeptModel);
        
        strCondition=" WHERE COMPANY_ID="+Long.toString(EITLERPGLOBAL.gCompanyID)+" ";
        
        List=clsDepartment.getList(strCondition);
        for(int i=1;i<=List.size();i++) {
            clsDepartment ObjDept=(clsDepartment) List.get(Integer.toString(i));
            ComboData aData=new ComboData();
            aData.Code=(int) ObjDept.getAttribute("DEPT_ID").getVal();
            aData.Text=(String)ObjDept.getAttribute("DEPT_DESC").getObj();
            aData.strCode="";
            cmbDeptModel.addElement(aData);
        }
        //------------------------------ //
        
    }
    
public void GenerateGrid()
{
    Connection tmpConn;
    Statement stTmp;
    ResultSet rsTmp;
    String strSQL="";
    
    try
    {
       strSQL=getSQL();
       
       FormatGrid();
       
       if(strSQL.trim().equals(""))
       {
          return; 
       }
        
       tmpConn=data.getConn();
       stTmp=tmpConn.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);
       rsTmp=stTmp.executeQuery(strSQL);
       rsTmp.first();
       
       int Counter=0;
       while(!rsTmp.isAfterLast())
       {
          Counter++;
          Object[] rowData=new Object[5];
          rowData[0]=Integer.toString(Counter);
          rowData[1]=rsTmp.getString("DOC_NO");
          rowData[2]=EITLERPGLOBAL.formatDate(rsTmp.getString("DOC_DATE"));
          
          if(rsTmp.getBoolean("APPROVED"))
          {
             rowData[3]="Approved";
          }
          else
          {
             rowData[3]=""; 
          }
          rowData[4]=Integer.toString(rsTmp.getInt("MODULE_ID"));
          
          DataModel.addRow(rowData);
          rsTmp.next();
       }
       

    //tmpConn.close();
    stTmp.close();
    rsTmp.close();
       
    }
    catch(Exception e)
    {
        
    }
}

private String getSQL()
{
    String strSQL="";

    SelModuleID=EITLERPGLOBAL.getComboCode(cmbModule);
    SelDeptID=EITLERPGLOBAL.getComboCode(cmbDept);

    if(txtDocNo.getText().trim().equals("")&&SelModuleID!=2)
    {
       JOptionPane.showMessageDialog(null,"Please enter the document no. you want to trace");
       return "";
    }
    
        
    if(SelModuleID==2) //Purchase Requisition
    {
        //Department specific Query
        if(chkDept.isSelected())
        {
           strSQL="SELECT REQ_NO AS DOC_NO,DATE_FORMAT(REQ_DATE,'%d/%m/%Y') AS DOC_DATE,APPROVED,2 AS MODULE_ID FROM D_INV_REQ_HEADER,D_COM_USER_MASTER WHERE D_INV_REQ_HEADER.COMPANY_ID=D_COM_USER_MASTER.COMPANY_ID AND D_INV_REQ_HEADER.CREATED_BY=D_COM_USER_MASTER.USER_ID AND D_COM_USER_MASTER.DEPT_ID="+SelDeptID+" AND D_INV_REQ_HEADER.COMPANY_ID="+EITLERPGLOBAL.gCompanyID; 
        }
        else
        {
           strSQL="SELECT REQ_NO AS DOC_NO,DATE_FORMAT(REQ_DATE,'%d/%m/%Y') AS DOC_DATE,APPROVED,2 AS MODULE_ID FROM D_INV_REQ_HEADER WHERE COMPANY_ID="+EITLERPGLOBAL.gCompanyID; 
        }
    }
    
    return strSQL;
}
    private void FormatGrid() {
        DataModel=new EITLTableModel();
        
        Table.removeAll();
        Table.setModel(DataModel);
        
        //Set the table Readonly
        DataModel.TableReadOnly(true);
            
        //Add Columns
        DataModel.addColumn("Sr.");
        DataModel.addColumn("Document No.");
        DataModel.addColumn("Document Date");
        DataModel.addColumn("Status"); //Approval Status
        DataModel.addColumn("Module ID");
        
        //Now hide the column 1
        TableColumnModel ColModel=Table.getColumnModel();
        Table.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);
    }
    
}
