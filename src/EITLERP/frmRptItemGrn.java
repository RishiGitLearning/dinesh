/*
 * frmRptGRNInfo.java
 *
 * Created on April 16, 2008, 12:01 PM
 */

package EITLERP;

/**
 *
 * @author  root
 */
import EITLERP.*;
import EITLERP.Finance.*;
import EITLERP.Utils.*;
import EITLERP.Stores.*;
import EITLERP.Utils.SimpleDataProvider.*;
import javax.swing.*;
import java.awt.*;
import java.sql.*;
import java.net.*;
import java.util.*;
import TReportWriter.*;

public class frmRptItemGrn extends javax.swing.JApplet {
    
    
    private TReportEngine objEngine=new TReportEngine();
    private TReportWriter.SimpleDataProvider.TTable objData=new TReportWriter.SimpleDataProvider.TTable();
    
    
    /** Initializes the applet frmRptGRNInfo */
    public void init() {
        setSize(424,264);
        initComponents();
        
        
    }
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        jPanel3 = new javax.swing.JPanel();
        jLabel6 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        txtToDate = new javax.swing.JTextField();
        cmdPreview = new javax.swing.JButton();

        getContentPane().setLayout(null);

        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                formMouseClicked(evt);
            }
        });

        jPanel3.setLayout(null);

        jPanel3.setBackground(new java.awt.Color(0, 153, 204));
        jPanel3.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jLabel6.setText("ITEM GRN");
        jPanel3.add(jLabel6);
        jLabel6.setBounds(9, 8, 230, 14);

        getContentPane().add(jPanel3);
        jPanel3.setBounds(0, 2, 800, 30);

        jLabel3.setText("As On Date :");
        getContentPane().add(jLabel3);
        jLabel3.setBounds(29, 69, 87, 19);

        txtToDate.setColumns(10);
        getContentPane().add(txtToDate);
        txtToDate.setBounds(120, 70, 90, 20);

        cmdPreview.setText("Preview Report");
        cmdPreview.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdPreviewActionPerformed(evt);
            }
        });

        getContentPane().add(cmdPreview);
        cmdPreview.setBounds(70, 180, 130, 23);

    }//GEN-END:initComponents
    
    private void formMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_formMouseClicked
        // TODO add your handling code here:
    }//GEN-LAST:event_formMouseClicked
    
    private void cmdPreviewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdPreviewActionPerformed
        // TODO add your handling code here:
        
        GenerateReport();
    }//GEN-LAST:event_cmdPreviewActionPerformed
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton cmdPreview;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JTextField txtToDate;
    // End of variables declaration//GEN-END:variables
    
    private void GenerateReport() {
        try {
            TReportWriter.SimpleDataProvider.TRow objRow;
            TReportWriter.SimpleDataProvider.TTable objReportData=new TReportWriter.SimpleDataProvider.TTable();
            
            objReportData.AddColumn("SR_NO");
            objReportData.AddColumn("ITEM_CODE");
            objReportData.AddColumn("OPENING_QTY");
            objReportData.AddColumn("GRN_NO");
            objReportData.AddColumn("GRN_DATE");
            objReportData.AddColumn("GRN_QTY");
            objReportData.AddColumn("GRN_VALUE");
            objReportData.AddColumn("BALANCE_QTY");
            objReportData.AddColumn("BALANCE_VALUE");
            
            
            TReportWriter.SimpleDataProvider.TRow objOpeningRow=objReportData.newRow();
            objOpeningRow.setValue("SR_NO","");
            objOpeningRow.setValue("ITEM_CODE","");
            objOpeningRow.setValue("OPENING_QTY","");
            objOpeningRow.setValue("GRN_NO","");
            objOpeningRow.setValue("GRN_DATE","0000-00-00");
            objOpeningRow.setValue("GRN_QTY","");
            objOpeningRow.setValue("GRN_VALUE","");
            objOpeningRow.setValue("BALANCE_QTY","");
            objOpeningRow.setValue("BALANCE_VALUE","");
            
            
            double OpeningQty = 0.0;
            String strSQL = "";
            String GRNNo="",GRNDate="";
            double GRNQty = 0,GRNValue = 0;
            double BalanceQty=0,BalanceValue=0;
            strSQL="SELECT * FROM D_INV_ITEM_MASTER WHERE ITEM_ID LIKE 'RM%' AND CANCELLED =0 AND APPROVED =1 AND COMPANY_ID = 3";
            
            //ResultSet rsItem=data.getResult(strSQL);
            ResultSet rsItem=data.getResult(strSQL,"jdbc:mysql://200.0.0.227:3306/DINESHMILLSA");
            
            ResultSet rsGRN;
            rsItem.first();
            
            int Counter = 0;
            int flag =0;
            if(rsItem.getRow()>0) {
                while(!rsItem.isAfterLast()) {
                    
                    Counter ++;
                    
                    String ItemId = rsItem.getString("ITEM_ID");
                    clsStockInfo objStock=new clsStockInfo();
                    objStock = new clsItemStock().getOnHandQtyOnEx1(3,ItemId.toString(),"2009-09-30"); 
                    
                    OpeningQty = objStock.StockQty;
                    
                    if (OpeningQty>0) {
                        //rsItem.next();
                        //continue;
                        
                    /*objRow.setValue("SR_NO",Integer.toString(Counter));
                    objRow.setValue("ITEM_CODE",Integer.toString(Counter));
                    objRow.setValue("OPENING_QTY",Integer.toString(Counter));*/
                        
                        strSQL = "SELECT * FROM D_INV_GRN_HEADER A ,D_INV_GRN_DETAIL B " +
                        "WHERE A.GRN_NO = B.GRN_NO AND A.APPROVED=1 AND CANCELLED = 0 " +
                        "AND B.ITEM_ID = '" + ItemId + "' AND " +
                        "ORDER BY GRN_DATE DESC";
                        
                        rsGRN = data.getResult(strSQL,"jdbc:mysql://200.0.0.227:3306/DINESHMILLSA");
                        double TotalGrnQty = 0;
                        
                        if(rsGRN.getRow()>0) {
                            double totalbalqty=OpeningQty,balanceqty=0, balancevalue=0;
                            while (!rsGRN.isAfterLast()){
                                GRNNo   =UtilFunctions.getString(rsGRN,"GRN_NO","");
                                GRNDate =EITLERPGLOBAL.formatDate(UtilFunctions.getString(rsGRN,"GRN_DATE","0000-00-00"));
                                GRNQty = rsGRN.getDouble("QTY");
                                GRNValue = rsGRN.getDouble("NET_AMOUNT");
                                
                                //if (GRNQty>=totalbalqty && flag==0) {
                                if (GRNQty>=totalbalqty ) {                                    
                                    balanceqty = EITLERPGLOBAL.round(totalbalqty,2);
                                    balancevalue = EITLERPGLOBAL.round(((balanceqty*GRNValue)/GRNQty),2);
                                    totalbalqty = 0;
                                    System.out.println("ItemID : "+ItemId + " Opening Qty.: "+OpeningQty +" GRN No.: "+GRNNo + " GRN Date : "+GRNDate + " GRN Qty.: "+GRNQty + " GRN Value: "+GRNValue + " Balance Qty.: "+balanceqty +" Balance Value: "+balancevalue);
                                    break;
                                }
                                else {
                                    
                                    balanceqty = EITLERPGLOBAL.round(GRNQty,2);
                                    balancevalue = EITLERPGLOBAL.round(GRNValue,2);
                                    totalbalqty = EITLERPGLOBAL.round(totalbalqty - GRNQty,2);
                                    //TotalGrnQty = TotalGrnQty + GRNQty;
                                    
                                    /*
                                     *if(TotalGrnQty > OpeningQty)
                                     *{
                                     *   System.out.println("ItemID : "+ItemId + " Opening Qty.: "+OpeningQty +" GRN No.: "+GRNNo + " GRN Date : "+GRNDate + " GRN Qty.: "+GRNQty + " GRN Value: "+GRNValue + " Balance Qty.: "+balanceqty +" Balance Value: "+balancevalue);
                                     *}
                                     */
                                    System.out.println("ItemID : "+ItemId + " Opening Qty.: "+OpeningQty +" GRN No.: "+GRNNo + " GRN Date : "+GRNDate + " GRN Qty.: "+GRNQty + " GRN Value: "+GRNValue + " Balance Qty.: "+balanceqty +" Balance Value: "+balancevalue);
                                    flag=1;
                                   /* if(totalbalqty < 0 ) {
                                        break;
                                    }*/
                                }
                                
                                rsGRN.next();
                            }
                        }
                        
                    }
                    
                    
                    rsItem.next();
                }
            }
            
            int Comp_ID = EITLERPGLOBAL.gCompanyID;
            HashMap Parameters=new HashMap();
            
            //Parameters.put("FROM_DATE",txtFromDate.getText().trim());
            //Parameters.put("TO_DATE",txtToDate.getText().trim());
            //Parameters.put("SYS_DATE",EITLERPGLOBAL.getCurrentDate());
            // Parameters.put("SCHEME_TYPE", Scheme_type);
            
            objEngine.PreviewReport("http://"+EITLERPGLOBAL.HostIP+"/EITLERP/Reports/finance/rptUnclaimedReceipts.rpt",Parameters,objReportData);
            
        }
        catch(Exception e) {
            e.printStackTrace();
        }
        
    }
    
    
    
}
