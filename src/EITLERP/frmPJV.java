/*
 * frmPJV.java
 *
 * Created on December 3, 2005, 2:57 PM
 */

package EITLERP;

/**
 *
 * @author  root
 */

import EITLERP.*;
import java.sql.*;
import java.io.*;
import javax.swing.*;
import java.awt.*;
import EITLERP.Utils.*;


public class frmPJV extends javax.swing.JApplet {
    
    /** Initializes the applet frmPJV */
    public void init() {
        setSize(427, 245);
        initComponents();
    }
    
    /** This method is called from within the init() method to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        txtFromDate = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        txtToDate = new javax.swing.JTextField();
        jLabel7 = new javax.swing.JLabel();
        txtFile = new javax.swing.JTextField();
        jButton1 = new javax.swing.JButton();
        cmdGenerate = new javax.swing.JButton();
        cmdGenerate1 = new javax.swing.JButton();
        
        getContentPane().setLayout(null);
        
        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                formMouseClicked(evt);
            }
        });
        
        jPanel1.setLayout(null);
        
        jPanel1.setBackground(new java.awt.Color(153, 153, 255));
        jPanel1.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        jLabel1.setText("PJV File Creation");
        jPanel1.add(jLabel1);
        jLabel1.setBounds(7, 9, 236, 15);
        
        getContentPane().add(jPanel1);
        jPanel1.setBounds(0, -1, 415, 32);
        
        jLabel4.setText("From Date ");
        getContentPane().add(jLabel4);
        jLabel4.setBounds(6, 66, 77, 15);
        
        getContentPane().add(txtFromDate);
        txtFromDate.setBounds(81, 64, 112, 20);
        
        jLabel5.setText("To Date");
        getContentPane().add(jLabel5);
        jLabel5.setBounds(219, 67, 53, 15);
        
        getContentPane().add(txtToDate);
        txtToDate.setBounds(277, 64, 112, 20);
        
        jLabel7.setText("Save as ");
        getContentPane().add(jLabel7);
        jLabel7.setBounds(23, 105, 59, 15);
        
        getContentPane().add(txtFile);
        txtFile.setBounds(81, 103, 270, 20);
        
        jButton1.setText("...");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        
        getContentPane().add(jButton1);
        jButton1.setBounds(353, 103, 35, 21);
        
        cmdGenerate.setText("Generate File");
        cmdGenerate.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdGenerateActionPerformed(evt);
            }
        });
        
        getContentPane().add(cmdGenerate);
        cmdGenerate.setBounds(38, 179, 140, 25);
        
        cmdGenerate1.setText("Exit");
        cmdGenerate1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdGenerate1ActionPerformed(evt);
            }
        });
        
        getContentPane().add(cmdGenerate1);
        cmdGenerate1.setBounds(206, 180, 140, 25);
        
    }//GEN-END:initComponents

    private void formMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_formMouseClicked
        // TODO add your handling code here:
    }//GEN-LAST:event_formMouseClicked
    
    private void cmdGenerateActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdGenerateActionPerformed
        // TODO add your handling code here:
        if(txtFromDate.getText().equals("")) {
            JOptionPane.showMessageDialog(null,"Please enter from date");
            return;
        }
        
        if(txtToDate.getText().equals("")) {
            JOptionPane.showMessageDialog(null,"Please enter to date");
            return;
        }
        
        if(txtFile.getText().equals("")) {
            JOptionPane.showMessageDialog(null,"Please specify file name");
            return;
        }
        
        if(!EITLERPGLOBAL.isDate(txtFromDate.getText())) {
            JOptionPane.showMessageDialog(null,"Please enter valid from date");
            return;
        }
        
        if(!EITLERPGLOBAL.isDate(txtToDate.getText())) {
            JOptionPane.showMessageDialog(null,"Please enter valid to date");
            return;
        }
        
        
        try {
            String strSQL="";
            ResultSet rsTmp;
            
            strSQL="SELECT A.GRN_NO,A.GRN_DATE,C.PO_DATE,IF(C.SUPP_ID IS NULL,'',C.SUPP_ID) SUPP_ID,B.PO_NO,A.INVOICE_NO,A.INVOICE_DATE,ROUND(SUM(B.QTY*B.LANDED_RATE),3) AS AMOUNT FROM  D_INV_GRN_HEADER A,D_INV_GRN_DETAIL B LEFT JOIN D_PUR_PO_HEADER C ON (B.PO_NO=C.PO_NO AND B.PO_TYPE=C.PO_TYPE) WHERE A.GRN_NO=B.GRN_NO AND A.GRN_TYPE=B.GRN_TYPE AND A.GRN_DATE>='"+EITLERPGLOBAL.formatDateDB(txtFromDate.getText())+"' AND A.GRN_DATE<='"+EITLERPGLOBAL.formatDateDB(txtToDate.getText())+"' AND A.CANCELLED=0 GROUP BY A.GRN_NO,B.PO_NO ";
            rsTmp=data.getResult(strSQL);
            rsTmp.first();
            
            if(rsTmp.getRow()>0) {
                BufferedWriter aFile=new BufferedWriter(new FileWriter(new File(txtFile.getText())));
                
                while(!rsTmp.isAfterLast()) {
                    String strGRNNo=EITLERPGLOBAL.padRight(12,rsTmp.getString("GRN_NO")," ");
                    String strGRNDate=rsTmp.getString("GRN_DATE");
                    String strSuppID=EITLERPGLOBAL.padRight(12,rsTmp.getString("SUPP_ID")," ");
                    String strPONo=EITLERPGLOBAL.padRight(12,rsTmp.getString("PO_NO")," ");
                    String strInvoiceNo=EITLERPGLOBAL.padRight(10,rsTmp.getString("INVOICE_NO")," ");
                    String strInvoiceDate=rsTmp.getString("INVOICE_DATE");

                    String strAmt=Double.toString(EITLERPGLOBAL.round((rsTmp.getDouble("AMOUNT")*100),0));
                    
                    strAmt=strAmt.substring(0,strAmt.length()-2);
                    
                    String strAmount=EITLERPGLOBAL.padLeft(15,strAmt," ");
                    
                    String strPODate=rsTmp.getString("PO_DATE");
                    
                    if(strPODate==null)
                    {
                      strPODate="0000-00-00";  
                    }
                    
                    aFile.write(strGRNNo+strGRNDate+strSuppID+strPONo+strPODate+strInvoiceNo+strInvoiceDate+strAmount);
                    aFile.newLine();
                    
                    rsTmp.next();
                }
                
                JOptionPane.showMessageDialog(null,"File generated successfully");
            }
            else {
                JOptionPane.showMessageDialog(null,"No entries found");
            }
            
            
        }
        catch(Exception e) {
            
        }
    }//GEN-LAST:event_cmdGenerateActionPerformed
    
    private void cmdGenerate1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdGenerate1ActionPerformed
        // TODO add your handling code here:
        ((JFrame)getParent().getParent().getParent().getParent()).dispose();
    }//GEN-LAST:event_cmdGenerate1ActionPerformed
    
    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
        FileDialog FileDialog=new FileDialog(findParentFrame(this));
        FileDialog.show();
        txtFile.setText(FileDialog.getDirectory()+FileDialog.getFile());
        
    }//GEN-LAST:event_jButton1ActionPerformed
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton cmdGenerate;
    private javax.swing.JButton cmdGenerate1;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JTextField txtFile;
    private javax.swing.JTextField txtFromDate;
    private javax.swing.JTextField txtToDate;
    // End of variables declaration//GEN-END:variables
    
    
    private Frame findParentFrame(JApplet pApplet) {
        Container c = (Container) pApplet;
        while(c != null) {
            if (c instanceof Frame)
                return (Frame)c;
            
            c = c.getParent();
        }
        return (Frame)null;
    }
    
}
